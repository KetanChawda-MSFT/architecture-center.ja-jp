---
title: "回復性のチェックリスト"
description: "設計時の回復性に関する問題のガイダンスを提供するチェックリスト。"
author: petertaylor9999
ms.date: 01/10/2018
ms.custom: resiliency, checklist
ms.openlocfilehash: 66ff802c1f7b35db147ffe4279982c827570c3c1
ms.sourcegitcommit: 3d6dba524cc7661740bdbaf43870de7728d60a01
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/11/2018
---
# <a name="resiliency-checklist"></a>回復性のチェックリスト

回復性とは、障害から回復して引き続き機能するシステムの能力であり、[ソフトウェア品質の重要な要素](../guide/pillars.md)の 1 つです。 回復性のあるアプリケーションを設計するには、発生する可能性のあるさまざまな障害モードに対して計画し、障害を緩和する必要があります。 このチェックリストを使用して、回復性の観点からアプリケーション アーキテクチャを見直します。 

## <a name="requirements"></a>必要条件

**顧客の可用性の要件を定義します。** 顧客にはアプリケーションのコンポーネントに対する可用性の要件があり、それがアプリケーションの設計に影響します。 アプリケーションの各部分の可用性のターゲットについて、顧客の同意を得てください。そうしないと、設計が顧客の期待に添わないものになる可能性があります。 詳細については、「[回復性の要件を定義する](../resiliency/index.md#defining-your-resiliency-requirements)」をご覧ください。

## <a name="application-design"></a>アプリケーションの設計

**アプリケーションの障害モード分析 (FMA) を実行します。** FMA は、設計の初期段階でアプリケーションに回復性を構築するためのプロセスです。 詳細については、「[障害モードの分析][fma]」をご覧ください。 FMA の目標は次のとおりです。  

* アプリケーションで発生する可能性がある障害のタイプを特定する。
* アプリケーションの各タイプの障害による潜在的な作用と影響を把握する。
* 復旧戦略を特定する。
  

**複数のインスタンスのサービスをデプロイします。** アプリケーションがサービスの 1 つのインスタンスに依存する場合は、単一障害点が発生します。 複数のインスタンスをプロビジョニングすると、回復性とスケーラビリティの両方が改善されます。 [Azure App Service](/azure/app-service/app-service-value-prop-what-is/) の場合は、複数のインスタンスを提供する [App Service プラン](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)を選択してください。 Azure Cloud Services の場合は、[複数インスタンス](/azure/cloud-services/cloud-services-choose-me/#scaling-and-management)を使用するように各ロールを構成してください。 [Azure Virtual Machines (VM)](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) の場合は、VM アーキテクチャに 1 つ以上の VM が含まれていることと、[可用性セット][availability-sets]に各 VM が含まれていることを確認してください。   

**自動スケールを使用して、負荷の増加に対応します。** 負荷が増したとき自動的にスケールアウトするようにアプリケーションが構成されていない場合は、ユーザーの要求で飽和状態になるとアプリケーションのサービスが失敗する可能性があります。 詳細については、次をご覧ください。

* 全般: [スケーラビリティのチェックリスト](./scalability.md)
* Azure App Service: [手動または自動によるインスタンス数のスケール変更][app-service-autoscale]
* Cloud Services: [クラウド サービスの自動スケールの方法][cloud-service-autoscale]
* 仮想マシン: [自動スケールと仮想マシン スケール セット][vmss-autoscale]

**負荷分散を使用して要求を分散します。** 負荷分散は、正常でないインスタンスをローテーションから除去することで、アプリケーションの要求を正常なサービス インスタンスに分散します。 サービスが Azure App Service または Azure Cloud Services を使用している場合は、既に負荷が分散されています。 ただし、アプリケーションが Azure VM を使用している場合は、ロード バランサーをプロビジョニングする必要があります。 詳細については、「[Azure Load Balancer ](/azure/load-balancer/load-balancer-overview/)の概要」をご覧ください。

**複数のインスタンスを使用するように Azure Application Gateway を構成します。** アプリケーションの要件によっては、アプリケーションのサービスに対する要求の分散には、[Azure Application Gateway](/azure/application-gateway/application-gateway-introduction/) のほうが適している場合があります。 ただし、Application Gateway サービスの単一インスタンスは SLA によって保証されないため、Application Gateway のインスタンスが失敗した場合はアプリケーションが失敗する可能性があります。 [SLA](https://azure.microsoft.com/support/legal/sla/application-gateway/v1_0/) の条件に基づいてサービスの可用性を保証するには、複数の中規模または大規模の Application Gateway インスタンスをプロビジョニングしてください。

**アプリケーション層ごとの可用性セットを使用します。** [可用性セット][availability-sets]にインスタンスを配置すると、[SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines/) がより高くなります。 

**アプリケーションを複数のリージョンにデプロイすることを検討します。** アプリケーションが 1 つのリージョンにデプロイされている場合は、まれにリージョン全体が使用できなくなった場合に、アプリケーションも使用できなくなります。 これは、アプリケーションの SLA の条件の下では許容できないことがあります。 その場合は、アプリケーションとそのサービスを複数のリージョンにデプロイすることを検討してください。 複数のリージョンのデプロイでは、アクティブ/アクティブ パターン (複数のアクティブなインスタンスに要求を分散する) またはアクティブ/パッシブ パターン (プライマリ インスタンスが失敗した場合に備えて「ウォーム」インスタンスを保持する) を使用できます。 アプリケーションのサービスの複数のインスタンスを、リージョンのペアにデプロイすることをお勧めします。 詳しくは、「[ビジネス継続性とディザスター リカバリー (BCDR): Azure のペアになっているリージョン](/azure/best-practices-availability-paired-regions)」をご覧ください。

**Azure Traffic Manager を使用して、アプリケーションのトラフィックをさまざまなリージョンにルーティングします。**  [Azure Traffic Manager][traffic-manager] は負荷分散を DNS レベルで実行し、指定した[トラフィック ルーティング][traffic-manager-routing]の方法とアプリケーションのエンドポイントの正常性に基づいてさまざまなリージョンにトラフィックをルーティングします。 Traffic Manager を使用しない場合、デプロイできるのは 1 つのリージョンに制限され、それによってスケールが制限され、一部のユーザーに待機時間が増加し、リージョン全体のサービスが停止した場合にアプリケーションのダウンタイムが発生します。

**ロード バランサーとトラフィック マネージャーの正常性プローブを構成し、テストします。** 必ず、正常性のロジックがシステムの重要な部分をチェックし、正常性プローブに適切に応答するようにしてください。

* [Azure Traffic Manager][traffic-manager] と [Azure Load Balancer][load-balancer] の正常性プローブは特定の機能を提供します。 Traffic Manager の場合、正常性プローブは別のリージョンにフェールオーバーするかどうかを決定します。 ロード バランサーの場合は、VM をローテーションから除去するかどうかを決定します。      
* Traffic Manager プローブでは、正常性エンドポイントが同じリージョン内にデプロイされている重要な依存関を確認し、その障害が別のリージョンへのフェールオーバーをトリガーします。  
* ロード バランサーでは、正常性エンドポイントが VM の正常性をレポートします。 その他の階層または外部サービスを含めないでください。 そうしないと、VM の外部で発生する障害によってロード バランサーがローテーションから VM を除去することになります。
* アプリケーションに正常性の監視を実装する方法については、「[正常性エンドポイント監視パターン](https://msdn.microsoft.com/library/dn589789.aspx)」をご覧ください。

**サード パーティーのサービスを監視します。** アプリケーションがサード パーティーのサービスに依存している場合は、それらのサード パーティーのサービスがどこでどのように失敗する可能性があるのかと、それらの障害がアプリケーションにどのような影響を与えるかを特定してください。 サード パーティーのサービスには監視と診断が含まれていないことがあるため、それらの呼び出しをログに記録し、一意の識別子を使用してアプリケーションの正常性と診断のログと関連付けることが重要です。 監視と診断の実証された方法については、「[監査と診断のガイダンス][monitoring-and-diagnostics-guidance]」をご覧ください。

**使用するサード パーティーのサービスが SLA が提供することを確認します。** アプリケーションがサード パーティーのサービスに依存していても、サード パーティーが SLA の形式での可用性を保証していない場合は、アプリケーションの可用性も保証できません。 SLA はアプリケーションの最小限使用可能なコンポーネントと同程度しかありません。

**必要に応じてリモート操作用の回復性のパターンを実装します。** アプリケーションがリモート サービス間の通信に依存する場合は、[再試行パターン][retry-pattern]や[サーキット ブレーカー パターン][circuit-breaker]などの一時的な障害に対処する設計パターンに従ってください。 詳細については、「[回復性戦略](../resiliency/index.md#resiliency-strategies)」をご覧ください。

**可能な限り、非同期操作を実装します。** 同期操作は、呼び出し元がプロセスの完了を待機している間はリソースを独占でき、その他の操作をブロックすることができます。 アプリケーションの各部分を、可能な限り非同期操作を許可するよう設計してください。 C# での非同期プログラミングの実装方法の詳細については、「[Async および Await を使用した非同期プログラミング][asynchronous-c-sharp]」をご覧ください。

## <a name="data-management"></a>[データ管理]

**アプリケーションのデータ ソースのレプリケーション方法を理解します。** アプリケーション データは、さまざまなデータ ソースに格納され、さまざまな可用性の要件を持ちます。 アプリケーションのデータ要件が確実に満たされるようにする [Azure Storage のレプリケーション](/azure/storage/storage-redundancy/)や [SQL Database のアクティブ geo レプリケーション](/azure/sql-database/sql-database-geo-replication-overview/)など、Azure のデータ ストレージの種類ごとにレプリケーションの方法を評価してください。

**1 つのユーザー アカウントで運用データとバックアップ データの両方にアクセスできることがないようにします。** 1 つのユーザー アカウントに運用とバックアップの両方のソースの両方に書き込みアクセス許可があると、データのバックアップが侵害されます。 悪意のあるユーザーはすべてのデータを意図的に削除する可能性があり、正規のユーザーは誤って削除する可能性があります。 各ユーザー アカウントのアクセス許可を制限して、書き込みアクセスを必要とするユーザーのみが書き込みアクセス権を持ち、それが運用環境とバックアップの両方ではなくどちらかに対するもののみになるように、アプリケーションを設計してください。

**データ ソースのフェールオーバーおよびフェールバックのプロセスを文書化し、それをテストします。** データ ソースに致命的な障害が発生した場合、オペレーターは、文書化されている手順に従って新しいデータ ソースにフェールオーバーする必要があります。 文書化されている手順に誤りがあると、オペレーターは適切にそれに従うことができず、リソースをフェールオーバーできなくなります。 手順を定期的にテストして、手順に従うオペレーターがフェールオーバーとフェールバックを正常に行えることを確認してください。

**データのバックアップを検証します。** データ整合性、スキーマ、およびクエリを検証するスクリプトを実行することで、バックアップ データが期待どおりのものであることを定期的に確認してください。 データ ソースを復元しても役に立たないのであれば、バックアップがあっても意味がありません。 バックアップ サービスを修復できるよう、不一致を記録し、レポートしてください。

**geo 冗長ストレージ アカウントであるストレージ アカウントの種類を使用することを検討してください。** Azure Storage アカウントに格納されているデータは、常にローカルでレプリケートされます。 ただし、ストレージ アカウントをプロビジョニングするときに選択するレプリケーション戦略は複数あります。 まれに発生するリージョン全体が使用できなくなったときに備えてアプリケーション データを保護するには、[Azure の読み取りアクセス geo 冗長ストレージ (RA-GRS)](/azure/storage/storage-redundancy/#read-access-geo-redundant-storage) を選択してください。

> [!NOTE]
> VM の場合は、RA-GRS レプリケーションを利用して VM ディスク (VHD ファイル) を復元しないでください。 代わりに、[Azure Backup][azure-backup] を使用してください。   
>
>

## <a name="security"></a>セキュリティ

**分散型サービス拒否 (DDoS) 攻撃に対するアプリケーション レベルの保護を実装します。** Azure サービスは、ネットワーク層で DDos 攻撃から保護されます。 ただし、悪意のあるユーザーの要求と本当のユーザーの要求を区別するのは難しいため、Azure ではアプリケーション層の攻撃から保護することができません。 アプリケーション層の DDoS 攻撃から保護する方法の詳細については、「[Microsoft Azure のネットワーク セキュリティ](http://download.microsoft.com/download/C/A/3/CA3FC5C0-ECE0-4F87-BF4B-D74064A00846/AzureNetworkSecurity_v3_Feb2015.pdf)」の「DDoS からの保護」のセクション(PDF のダウンロード) をご覧ください。

**アプリケーションのリソースへのアクセスに対する最小限の権限の原則を実装します。** アプリケーションのリソースへのアクセスの既定値は、可能な限り制限する必要があります。 承認によって付与する権限のレベルを上げてください。 アプリケーションのリソースに既定で過度なアクセス権を付与すると、意図的であれ意図せずであれリソースが削除されてしまう可能性があります。 Azure はユーザーのアクセス許可を管理する[ロールベースのアクセス制御](/azure/active-directory/role-based-access-built-in-roles/)を備えていますが、SQL Server などの独自のアクセス許可システムを持つ他のリソースの最小特権のアクセス許可を確認することが重要です。

## <a name="testing"></a>テスト

**アプリケーションに対してフェールオーバーとフェールバックのテストを実行します。** フェールオーバーとフェールバックを完全にテストしていない場合は、アプリケーション内の依存サービスが障害復旧時に同期的にバックアップされるとは確信できません。 アプリケーションの依存サービスのフェールオーバーとフェールバックが、確実に正しい順序で行われるようにしてください。

**アプリケーションに対してフォールト挿入テストを実行します。** アプリケーションは、証明書の有効期限、VM のシステム リソースの枯渇、ストレージ障害など、多くのさまざまな理由で障害が発生することがあります。 運用環境にできるだけ近い環境で、実際の障害をシミュレートまたはトリガーして、アプリケーションをテストしてください。 たとえば、証明書を削除したり、システム リソースを人為的に消費したり、ストレージ ソースを削除したりします。 単独でも組み合わせでも、あらゆるタイプの障害からアプリケーションを復旧できることを確認してください。 障害がシステムを介して反映されたり連鎖したりしないことを確認してください。

**人工的なユーザー データと実際のユーザー データの両方を使用して、運用環境でテストを実行します。** テストと運用はほとんど同じですので、Blue/Green またはカナリヤ デプロイを使用し、運用環境でアプリケーションをテストすることが重要です。 これにより、実際の負荷がかかった運用環境でアプリケーションをテストでき、完全にデプロイしたときに期待どおりに機能することを確認できます。

## <a name="deployment"></a>デプロイ

**アプリケーションのリリース プロセスを文書化します。** 詳細なリリース プロセスのドキュメントがなければ、オペレーターが不適切な更新プログラムやアプリケーションに不適切な構成設定をデプロイする可能性があります。 リリース プロセスを明確に定義して文書化し、オペレーション チーム全体が確実に利用できるようにしてください。 

**アプリケーションのデプロイ プロセスを自動化します。** 運用スタッフがアプリケーションを手動でデプロイする必要がある場合は、人的ミスによってデプロイに失敗する可能性があります。 

**アプリケーションの可用性を最大限にするリリース プロセスを設計します。** リリース プロセスでデプロイ中にサービスをオフラインにする必要がある場合、オンラインに戻るまでアプリケーションは使用できなくなります。 アプリケーションを運用環境にデプロイするには、[Blue/Green](http://martinfowler.com/bliki/BlueGreenDeployment.html) または[カナリヤ リリース](http://martinfowler.com/bliki/CanaryRelease.html)のデプロイ手法を使用してください。 これらの手法のどちらにも、障害発生時にリリース コードのユーザーが運用環境のコードにリダイレクトできるように、運用環境のコードと共にリリース コードをデプロイすることが含まれます。

**アプリケーションのデプロイを記録し、監査します。** Blue/Green やカナリヤ リリースなどのステージング デプロイ手法を使用する場合、運用環境では複数のバージョンのアプリケーションが実行されることになります。 万一問題が発生した場合は、アプリケーションのどのバージョンが問題の原因かを判別することが重要です。 できるだけ多くのバージョン固有の情報を把握するため、確実なログ記録の方法を実装してください。

**デプロイのロールバック計画を立てます。** アプリケーションのデプロイが失敗し、アプリケーションが使用できなくなる可能性があります。 直前の正常なバージョンに戻して、ダウンタイムを最小限に抑えるために、ロールバック プロセスを設計してください。 

## <a name="operations"></a>[操作]

**アプリケーションの監視とアラートのためのベスト プラクティスを実装します。** 適切な監視、診断、およびアラートがなければ、アプリケーションで障害を検出してそれらを修正するようオペレーターに警告する方法がありません。 詳細については、「[監視と診断のガイダンス][monitoring-and-diagnostics-guidance]」をご覧ください。

**リモート呼び出しの統計情報を測定し、アプリケーション チームがその情報を使用できるようにします。**  リモート呼び出しの統計情報をリアルタイムで追跡してレポートせず、この情報を確認する簡単な方法を用意しないと、運用チームはアプリケーションの正常性を瞬時に確認することができなくなります。 また、リモート呼び出しの平均時間のみを測定しても、サービスの問題を明らかにするのに十分な情報は得られません。 待機時間、スループット、および 99 および 95 パーセンタイルのエラーなど、リモート呼び出しのメトリックをまとめてください。 各パーセンタイル内で発生したエラーを明らかにするには、このメトリックで統計分析を実行してください。

**適切な期間の間の一時的な例外と再試行の数を追跡します。** 長時間にわたる一時的な例外と再試行の試みを追跡して監視しないと、アプリケーションの再試行ロジックによって問題や障害が隠れてしまう可能性があります。 つまり、監視とログ記録が操作の成功または失敗しか示していなければ、例外によって操作を複数回再試行する必要があったという事実は隠れてしまいます。 時間をかけて例外が増加する傾向は、サービスに問題があるか失敗する可能性があることを示します。 詳細については、「[再試行サービス固有のガイダンス][retry-service-guidance]」をご覧ください。

**オペレーターに通知する早期警告システムを実装します。** 一時的な例外やリモート呼び出しの待機時間などのアプリケーションの正常性の主要業績評価指標を特定し、それぞれに適切なしきい値を設定してください。 しきい値に達したときに、操作にアラートを送信します。 問題が重大になり、復旧対応が必要になる前に、問題を特定するレベルでこれらのしきい値を設定してください。

**アプリケーションの監視と手動の復旧手順の実行について、チームの複数のメンバーに確実にトレーニングを実施してください。** アプリケーションを監視し、復旧手順を開始できるオペレーターがチームに 1 人しかいないと、その人が単一障害点になります。 検出と復旧に関するトレーニングを複数の人に対して実施し、常に少なくとも 1 人がいつでも活動しているようにしてください。

**アプリケーションが [Azure サブスクリプションの制限](/azure/azure-subscription-service-limits/)と衝突しないようにします。** Azure サブスクリプションには、リソース グループの数、コアの数、およびストレージ アカウントの数など、特定のリソースの種類に対する制限があります。  アプリケーションの要件が Azure サブスクリプションの制限を超えた場合は、別の Azure サブスクリプションを作成し、そこに十分なリソースをプロビジョニングしてください。

**アプリケーションが[サービスごとの制限](/azure/azure-subscription-service-limits/)と衝突しないようにします。** 個々 の Azure サービスには消費量に制限があります。たとえば、ストレージ、スループット、接続数、秒あたりの要求、およびその他のメトリックに関する制限です。 これらの制限を超えてリソースを使用しようとすると、アプリケーションは失敗します。 これにより、影響を受けるユーザーにサービスの調整とダウンタイムの可能性が生じることになります。 特定のサービスとアプリケーションの要件に応じて、(たとえば、別の価格層を選択して) スケールアップするか、(新しいインスタンスを追加して) スケールアウトすることで、多くの場合はこれらの制限を回避できます。  

**アプリケーションのストレージの要件を、Azure ストレージのスケーラビリティとパフォーマンスのターゲットの範囲に入るように設計します。** Azure ストレージは、事前定義済みのスケーラビリティとパフォーマンスのターゲットの中で機能するように設計されているため、それらのターゲットの中でストレージを利用するようにアプリケーションを設計してください。 これらのターゲットを上回ると、アプリケーションでストレージが調整されます。 これを解決するには、追加のストレージ アカウントをプロビジョニングします。 ストレージ アカウントの制限と衝突する場合は、追加の Azure サブスクリプションをプロビジョニングしてから、そこに追加のストレージ アカウントをプロビジョニングしてください。 詳細については、「 [Azure Storage のスケーラビリティおよびパフォーマンスのターゲット](/azure/storage/storage-scalability-targets/)」をご覧ください。

**アプリケーションに適した VM サイズを選択します。** 運用環境の VM の実際の CPU、メモリ、ディスク、および I/O を測定し、選択した VM のサイズが十分であることを確認してください。 そうでない場合は、VM がその制限に近くなると、アプリケーションで容量の問題が発生する可能性があります。 VM のサイズについては、「[Azure の仮想マシンのサイズ](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)」をご覧ください。

**アプリケーションのワークロードが安定しているか変動しているかを確認します。** 時間をかけてワークロードが変動する場合は、VM スケール セットを使用して VM インスタンスの数を自動的にスケールしてください。 そうしないと、VM の数の手動での増減が必要になります。 詳細については、「[仮想マシン スケール セットの概要](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/)」をご覧ください。

**Azure SQL Database に適したサービス層を選択します。** アプリケーションが Azure SQL Database を使用する場合は、必ず適切なサービス層を選択してください。 アプリケーションのデータベース トランザクション ユニット (DTU) の要件を処理できない層を選択すると、データの使用が調整されます。 適切なサービス プランの選択の詳細については、「[SQL Database のオプションとパフォーマンス: 各サービス階層で使用できる内容について理解します](/azure/sql-database/sql-database-service-tiers/)」をご覧ください。

**Azure のサポートとやり取りするためのプロセスを作成します。** サポートに問い合わせる必要が生じる前に [Azure のサポート](https://azure.microsoft.com/support/plans/)に問い合わせるプロセスが設定されていないと、サポート プロセスを進めるのが初めての場合はダウンタイムが長引きます。 サポートへの問い合わせと問題のエスカレーションのプロセスを、最初からアプリケーションの回復性の一部として組み込んでください。

**アプリケーションが最大数を超えるサブスクリプションあたりのストレージ アカウントを使用しようしないようにします。** Azure では、サブスクリプションごとに最大 200 のストレージ アカウントを使用できます。 アプリケーションに現時点でサブスクリプションで使用できるものよりも多くのストレージ アカウントが必要な場合は、新しいサブスクリプションを作成し、そこに追加のストレージ アカウントを作成する必要があります。 詳細については、「[Azure サブスクリプションとサービスの制限、クォータ、制約](/azure/azure-subscription-service-limits/#storage-limits)」をご覧ください。

**アプリケーションが仮想マシンのディスクのスケーラビリティのターゲットを超えないようにします。** Azure IaaS VM は、VM のサイズやストレージ アカウントの種類など、いくつかの要因に応じたデータ ディスクの数の接続をサポートします。 アプリケーションが仮想マシンのディスクのスケーラビリティのターゲットを超える場合は、追加のストレージ アカウントをプロビジョニングし、そこに仮想マシンのディスクを作成してください。 詳細については、「[Azure Storage のスケーラビリティおよびパフォーマンスのターゲット](/azure/storage/storage-scalability-targets/#scalability-targets-for-virtual-machine-disks)」をご覧ください。

## <a name="telemetry"></a>テレメトリ

**アプリケーションの運用環境で実行されているときに、利用統計情報を記録します。** アプリケーションが運用環境で実行されているとき、またはユーザーに積極的にサービスを提供している間の問題の原因を診断するのに十分な情報がないときは、確実な利用統計情報を把握してください。 詳細については、「[監視と診断][monitoring-and-diagnostics-guidance]」をご覧ください。

**非同期パターンを使用してログ記録を実装します。** ログ記録操作が同期の場合は、アプリケーション コードがブロックされる可能性があります。 ログ記録操作が非同期操作として実装されるようにしてください。

**サービスの境界をまたがるログ データを関連付けます。** 一般的な n 層のアプリケーションでは、ユーザーの要求はいくつかのサービスの境界を経由することがあります。 たとえば、ユーザーの要求は、通常は Web 層で発生し、ビジネス層に渡されて、最終的にデータ層に保持されます。 より複雑なシナリオでは、ユーザーの要求は多くのさまざまなサービスとデータ ストアに分散されることがあります。 ログ記録システムは、アプリケーション全体で要求を追跡できるように、必ずサービス境界をまたがる呼び出しを関連付けてください。

## <a name="azure-resources"></a>Azure リソース

**Azure Resource Manager テンプレートを使用してリソースをプロビジョニングします。** Resource Manager テンプレートは、PowerShell または Azure CLI を使用してデプロイを自動化しやすくし、それがより信頼性の高いデプロイ プロセスにつながります。 詳細については、「[Azure Resource Manager の概要][resource-manager]」をご覧ください。

**リソースにわかりやすい名前を付けます。** リソースにわかりやすい名前を付けることで、特定のリソースを見つけて、その役割を理解することが簡単になります。 詳細については、「[Azure リソースの名前付け規則](../best-practices/naming-conventions.md)」をご覧ください。

**ロール ベースのアクセス制御 (RBAC) を使用します。** RBAC を使用して、デプロイする Azure リソースへのアクセスを制御してください。 RBAC を使用すると、DevOps チームのメンバーに承認の役割を割り当てて、デプロイ済みのリソースが誤って削除されたり変更されたりするのを防ぐことができます。 詳細については、「[Azure Portal でのアクセス管理の概要](/azure/active-directory/role-based-access-control-what-is/)」をご覧ください。

**VM などの重要なリソースにリソースのロックを使用します。** リソースのロックは、オペレーターがリソースを誤って削除するのを防ぎます。 詳細については、[「Azure Resource Manager によるリソースのロック」](/azure/azure-resource-manager/resource-group-lock-resources/)をご覧ください。

**リージョンのペアを選択します。** 2 つのリージョンにデプロイする場合は、同じリージョンのペアからリージョンを選択してください。 広範囲にわたって障害が発生した場合は、すべてのペアのうちの 1 つのリージョンの復旧が優先されます。 geo 冗長ストレージなど一部のサービスには、ペア リージョンへの自動レプリケーション機能が用意されています。 詳しくは、「[ビジネス継続性とディザスター リカバリー (BCDR): Azure のペアになっているリージョン](/azure/best-practices-availability-paired-regions)」をご覧ください。

**リソース グループを機能別とライフサイクル別にまとめます。**  一般に、リソース グループには、同じライフサイクルを共有するリソースを含める必要があります。 これにより、デプロイの管理、テスト デプロイの削除、およびアクセス権の割り当てが簡単になり、運用デプロイが誤って削除されたり変更されたりする可能性が低くなります。 運用、開発、およびテスト環境用に別々のリソース グループを作成してください。 複数リージョンのデプロイでは、各リージョン用のリソースを別々のリソース グループに配置してください。 これにより、他のリージョンに影響を与えずに、1 つのリージョンに簡単に再デプロイできます。

## <a name="azure-services"></a>Azure サービス
次のチェックリストの項目は、Azure の特定のサービスに適用されます。

- [App Service](#app-service)
- [Application Gateway](#application-gateway)
- [Cosmos DB](#cosmos-db)
- [Redis Cache](#redis-cache)
- [Search](#search)
- [Storage](#storage)
- [SQL Database](#sql-database)
- [VM で実行されている SQL Server](#sql-server-running-in-a-vm)
- [Traffic Manager](#traffic-manager)
- [Virtual Machines](#virtual-machines)
- [Virtual Network](#virtual-network)

### <a name="app-service"></a>App Service

**Standard または Premium 層を使用します。** これらの階層は、ステージング スロットと自動バックアップをサポートします。 詳細については、「[Azure App Service プランの詳細な概要](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)」を参照してください

**スケールアップまたはスケールダウンを回避します｡** 代わりに、通常の負荷の下でパフォーマンスの要件を満たす階層とインスタンスのサイズを選択してから、インスタンスを[スケールアウト](/azure/app-service-web/web-sites-scale/)してトラフィック量の変化を処理してください。 スケールアップとスケールダウンにより、アプリケーションの再起動がトリガーされることがあります。  

**構成をアプリ設定として格納します。** アプリ設定を使用して、構成設定をアプリケーション設定として格納してください。 Resource Manager テンプレートに、または PowerShell 使用して設定を定義して、それを自動化されたデプロイや更新プロセスの一部として適用できるようにしてください。それによって信頼性が向上します。 詳細については、「[Azure App Service での Web アプリの構成](/azure/app-service-web/web-sites-configure/)」をご覧ください。

**運用とテスト用に別々の App Service プランを作成します。** テストには運用環境のデプロイのスロットを使用しないでください。  同じ App Service プラン内のすべてのアプリが同じ VM インスタンスを共有します。 運用デプロイとテスト デプロイを同じプランに入れると、運用デプロイに悪影響を与える可能性があります。 たとえば、負荷テストは実稼働の運用サイトを低下させる可能性があります。 テスト デプロイを別のプランに入れることで、運用バージョンから分離してください。  

**Web アプリから Web API を分離します。** ソリューションに Web フロントエンドと Web API の両方がある場合は、それらを別々の App Service アプリに分解することを検討してください。 この設計により、ソリューションをワークロード別に分解しやすくなります。 Web アプリと API を別々の App Service プランで実行できるため、それらを個別にスケーリングできるようになります。 最初はこのレベルのスケーラビリティが不要な場合は、アプリを同じプランにデプロイし、後で必要に応じて別のプランに移行することができます。

**Azure SQL データベースをバックアップするのに App Service バックアップ機能を使用しないでください。** 代わりに、[SQL Database 自動バックアップ][sql-backup]を使用してください。 App Service のバックアップはデータベースを SQL .bacpac ファイルにエクスポートし、これには DTU のコストがかかります。  

**ステージング スロットにデプロイします。** ステージング用のデプロイ スロットを作成します。 アプリケーションの更新プログラムをステージング スロットにデプロイし、運用環境にスワップする前にデプロイを確認してください。 これにより、運用環境で不正な更新が発生する可能性が減少します。 また、すべてのインスタンスが、運用環境にスワップする前に確実にウォーム アップされます。 多くのアプリケーションではウォームアップとコールドスタートに多くの時間がかかります。 詳細については、「[Azure App Service の Web アプリのステージング環境を設定する](/azure/app-service-web/web-sites-staged-publishing/)」をご覧ください。

**前回正常起動時 (LKG) のデプロイを保持するデプロイ スロットを作成します。** 運用環境に更新プログラムをデプロイするときは、以前の運用環境のデプロイを LKG スロットに移動してください。 これにより、不適切なデプロイをより簡単にロールバックできます。 後で問題を見つけた場合は、LKG バージョンにすばやく戻ることができます。 詳細については、[基本的な Web アプリケーション](../reference-architectures/app-service-web-app/basic-web-app.md)に関するページをご覧ください。

アプリケーションのログ記録や Web サーバーのログ記録を含む、**診断のログ記録を有効にしてください**。 監視と診断にはログ記録が重要です。 「[Azure App Service での Web アプリの診断ログの有効化](/azure/app-service-web/web-sites-enable-diagnostic-log/)」をご覧ください。

**Blob Storage にログを記録します。** これによって、データの収集と分析が簡単になります。

**ログ用の別のストレージ アカウントを作成します。** ログとアプリケーション データに同じストレージ アカウントを使用しないでください。 これは、ログ記録によってアプリケーションのパフォーマンスが低下するのを防ぐのに役立ちます。

**パフォーマンスを監視します。** [New Relic](http://newrelic.com/) や[Application Insights](/azure/application-insights/app-insights-overview/) などのパフォーマンス監視サービスを使用して、負荷がかかった状態のアプリケーションのパフォーマンスと動作を監視してください。  パフォーマンスの監視により、アプリケーションをリアルタイムで理解できます。 これにより、問題を診断し、障害の根本原因分析を行うことができます。

### <a name="application-gateway"></a>Application Gateway

**少なくとも 2 つのインスタンスをプロビジョニングします。** 少なくとも 2 つのインスタンスのある Application Gateway をデプロイしてください。 単一のインスタンスは、単一障害点です。 冗長性とスケーラビリティのために、2 つ以上のインスタンスを使用してください。 [SLA](https://azure.microsoft.com/support/legal/sla/application-gateway/v1_0/) に適合するためには、2 つ以上のメディアまたは大きめのインスタンスをプロビジョニングする必要があります。

### <a name="cosmos-db"></a>Cosmos DB

**リージョン間でデータベースをレプリケートします。** Cosmos DB では、Cosmos DB データベース アカウントに Azure リージョンをいくつでも関連付けることができます。 Cosmos DB データベースには、1 つの書き込みリージョンと複数の読み取りリージョンを含めることができます。 書き込みリージョンに障害がある場合は、別のレプリカから読み取ることができます。 クライアント SDK はこれを自動的に処理します。 書き込みリージョンを別のリージョンにフェールオーバーすることもできます。 詳細については、「[Azure Cosmos DB を使用してデータをグローバルに分散させる方法](/azure/documentdb/documentdb-distribute-data-globally)」をご覧ください。

### <a name="redis-cache"></a>Redis Cache

**geo レプリケーションを構成します。** geo レプリケーションは、Premium レベルの Azure Redis Cache の 2 つのインスタンスをリンクするメカニズムを用意しています。 プライマリ キャッシュに書き込まれたデータは、読み取り専用のセカンダリ キャッシュにレプリケートされます。 詳細については、「[Azure Redis Cache の geo レプリケーションの構成方法](/azure/redis-cache/cache-how-to-geo-replication)」をご覧ください。

**データ永続化を構成します。** Redis の永続化を使用すると、Redis に格納されたデータを保持できます。 また、スナップショットを取得したりデータをバックアップしたりして、ハードウェア障害のときに読み込むことができます。 詳細については、「[Premium Azure Redis Cache のデータ永続化の構成方法](/azure/redis-cache/cache-how-to-premium-persistence)」をご覧ください。

永続ストアとしてではなく、一時的なデータ キャッシュとして Redis Cache を使用する場合、これらの推奨事項は適用されません。 

### <a name="search"></a>検索

**複数のレプリカをプロビジョニングします。** 読み取りの高可用性のためには少なくとも 2 つのレプリカ、読み取り/書き込みの高可用性のためには少なくとも 3 つのレプリカを使用してください。

**複数リージョンのデプロイ用のインデクサーを構成します。** 複数リージョンのデプロイがある場合は、インデックス作成の継続性のためのオプションを検討してください。

  * データ ソースが geo レプリケーションされている場合は、一般に、各リージョンの Azure Search サービスのそれぞれのインデクサーをそのローカル データ ソース レプリカにポイントする必要があります。 ただし、このアプローチは、Azure SQL データベースに格納されている大規模なデータセットは推奨されません。 その理由は、Azure Search がセカンダリ SQL Database レプリカからは増分インデックス作成を実行できず、プライマリ レプリカからしか実行できないためです。 代わりに、すべてのインデクサーをプライマリ レプリカにポイントしてください。 フェールオーバー後は、新しいプライマリ レプリカで Azure Search インデクサーをポイントします。  
  * データ ソースが geo レプリケートされていない場合は、同じデータ ソースにある複数のインデクサーをポイントして、複数のリージョン内の Azure Search サービスがデータ ソースからのインデックス作成を継続的に単独で行うようにしてください。 詳細については、「[Azure Search のパフォーマンスと最適化に関する考慮事項][search-optimization]」をご覧ください。

### <a name="storage"></a>Storage

**アプリケーション データには、読み取りアクセス geo 冗長ストレージ (RA-GRS)** を使用します。 RA-GRS ストレージは、セカンダリ リージョンにデータをレプリケートし、セカンダリ リージョンからの読み取り専用のアクセスを提供します。 プライマリ リージョンでストレージが停止した場合、アプリケーションはセカンダリ リージョンからデータを読み取ることができます。 詳細については、「[Azure Storage のレプリケーション](/azure/storage/storage-redundancy/)」をご覧ください。

**VM ディスクには、Managed Disks を使用します。** [Managed Disks][managed-disks] では、ディスクが単一障害点にならないように相互に十分に分離されるため、可用性セットの VM の信頼性が向上します。 また、Managed Disks はストレージ アカウントで作成した VHD 制限の対象ではありません。 詳細については、「[Azure での Windows 仮想マシンの可用性の管理][vm-manage-availability]」をご覧ください。

**Queue Storage では、別のリージョンにバックアップ キューを作成します。** Queue Storage の場合、項目のキューやデキューができないため、読み取り専用レプリカの使用は制限されています。 代わりに、別のリージョンのストレージ アカウントにバックアップ キューを作成します。 ストレージの障害がある場合、アプリケーションは、プライマリ リージョンが再び使用可能になるまで、バックアップ キューを使用できます。 したがって、アプリケーションは、引き続き新しい要求を処理できます。  

### <a name="sql-database"></a>SQL Database

**Standard または Premium 層を使用します。** これらの階層は、より長いポイントインタイム リストア期間 (35 日間) を提供します。 詳細については、「[SQL Database のオプションとパフォーマンス](/azure/sql-database/sql-database-service-tiers/)」をご覧ください。

**SQL Database の監査を有効にします。** 監査は、悪意のある攻撃や人的ミスの診断に使用できます。 詳細については、「 [SQL Database 監査の使用](/azure/sql-database/sql-database-auditing-get-started/)」をご覧ください。

**アクティブ Geo レプリケーションを使用します。** アクティブ Geo レプリケーションを使用して、さまざまなリージョンに読み取り可能なセカンダリ レプリカを作成します。  プライマリ データベースに障害が発生した場合、またはオフラインにする必要がある場合は、セカンダリ データベースへの手動フェールオーバーを実行します。  セカンダリ データベースは、フェールオーバーするまでは読み取り専用のままです。  詳細については、「[Azure SQL Database のアクティブ geo レプリケーション](/azure/sql-database/sql-database-geo-replication-overview/)」をご覧ください。

**シャーディングを使用します。** シャーディングを使用して、データベースを水平方向にパーティション分割することを検討してください。 シャーディングによって障害を分離できます。 詳細については、「[Azure SQL Database によるスケール アウト](/azure/sql-database/sql-database-elastic-scale-introduction/)」をご覧ください。

**人的ミスから復旧するには、ポイントインタイム リストアを使用します。**  ポイントインタイム リストアは、データベースを以前の特定の時点に戻します。 詳細については、「[データベースの自動バックアップを使用した Azure SQL Database の復旧][sql-restore]」をご覧ください。

**サービスの停止から復旧するには、geo リストアを使用します。** geo リストアは geo 冗長バックアップからデータベースを復元します。  詳細については、「[データベースの自動バックアップを使用した Azure SQL Database の復旧][sql-restore]」をご覧ください。

### <a name="sql-server-running-in-a-vm"></a>VM で実行されている SQL Server

**データベースをレプリケートします。** データベースをレプリケートするには、SQL Server Always On 可用性グループを使用します。 1 つの SQL Server インスタンスが失敗した場合は、高可用性を提供してください。 詳細については、「[n 層アプリケーションの Windows VM を実行する](../reference-architectures/virtual-machines-windows/n-tier.md)」をご覧ください。

**データベースをバックアップします。** 既に [Azure Backup](https://azure.microsoft.com/documentation/services/backup/) を使用して VM をバックアップしている場合は、[DPM を使用した SQL Server ワークロード用 Azure Backup](/azure/backup/backup-azure-backup-sql/) を使用することを検討してください。 このアプローチでは、組織用の 1 つのバックアップ管理者の役割と、VM および SQL Server 用の 1 つにまとめられた復旧手順があります。 それ以外の場合は、[Microsoft Azure への SQL Server マネージ バックアップ](https://msdn.microsoft.com/library/dn449496.aspx)を使用してください。

### <a name="traffic-manager"></a>Traffic Manager

**手動フェールバックを実行します。** Traffic Manager のフェールオーバーの後は、自動的にフェールバックするのではなく、手動フェールバックを実行してください。 フェールバックする前に、すべてのアプリケーション サブシステムが正常であることを確認してください。  これを行わないと、データセンター間でアプリケーションが切り替わる状況が発生する可能性があります。 詳細については、「[高可用性を得るために複数のリージョンで VM を実行する](../reference-architectures/virtual-machines-windows/multi-region-application.md)」をご覧ください。

**正常性プローブのエンドポイントを作成します。** アプリケーションの全体的な正常性についてレポートするカスタム エンドポイントを作成してください。 これにより、クリティカル パスが失敗した場合に、フロント エンドだけでなく Traffic Manager をフェールオーバーできます。 エンドポイントは、重要な依存関係が正常でない場合、または到達できない場合に、HTTP エラー コードを返す必要があります。 ただし、重要でないサービスについてはレポートしないでください。 そうしないと、必要のないときに正常性プローブがフェールオーバーをトリガーして、誤検知が生じる可能性があります。 詳細については、「[Traffic Manager エンドポイントの監視とフェールオーバー](/azure/traffic-manager/traffic-manager-monitoring/)」をご覧ください。

### <a name="virtual-machines"></a>[Virtual Machines]

**単一の VM で運用環境のワークロードを実行しないでください。** 単一の VM のデプロイには計画または計画外メンテナンスに対する回復力がありません。 代わりに、複数の VM を可用性セットまたは [VM スケール セット](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/)に配置し、前面にロード バランサーを配置してください。

**VM をプロビジョニングするときに、可用性セットを指定します。** 現時点では、VM がプロビジョニングされた後に、VM を可用性セットに追加する方法はありません。 既存の可用性セットに新しい VM を追加するときは、必ず VM 用の NIC を作成し、NIC をロード バランサーのバックエンド アドレス プールに追加してください。 そうしないと、ロード バランサーがその VM にネットワーク トラフィックをルーティングしなくなります。

**各アプリケーション層を別々の可用性セットに配置します。** N 層のアプリケーションでは、同じ可用性セットの別の層からは VM を配置しないでください。 可用性セット内の VM は、障害ドメイン (FD) と更新ドメイン (UD) にまたがって配置されています。 ただし、FD と UD の冗長性の利点を活用するには、可用性セットのすべての VM が同じクライアント要求を処理できる必要があります。

**パフォーマンスの要件に基づいて適切な VM サイズを選択します。** 既存のワークロードを Azure に移動する場合は、オンプレミスのサーバーに最も適合性が高い VM サイズから開始します。 次に、CPU、メモリ、およびディスクの IOPS について、実際のワークロードのパフォーマンスを測定し、必要に応じてサイズを調整します。 これにより、アプリケーションがクラウド環境で期待どおりに動作することを確認できます。 また、複数の NIC が必要な場合は、各サイズの NIC の制限に注意してください。

**VHD 用の Managed Disks を使用します。** [Managed Disks][managed-disks] では、ディスクが単一障害点にならないように相互に十分に分離されるため、可用性セットの VM の信頼性が向上します。 また、Managed Disks はストレージ アカウントで作成した VHD 制限の対象ではありません。 詳細については、「[Azure での Windows 仮想マシンの可用性の管理][vm-manage-availability]」をご覧ください。

**OS ディスクではなく、データ ディスクにアプリケーションをインストールします。** そうしないと、ディスク サイズの上限に達する可能性があります。

**Azure Backup を使用して VM をバックアップします。** バックアップにより偶発的なデータ損失から保護されます。 詳細については、「[Recovery Services コンテナーを使用した Azure VM の保護](/azure/backup/backup-azure-vms-first-look-arm/)」をご覧ください。

基本的な正常性メトリック、インフラストラクチャ ログ、および[ブート診断][boot-diagnostics]などの**診断ログ**を有効にします。 VM が起動不可能な状態になった場合は、起動エラーを診断するのにブート診断が役立ちます。 詳細については、「[Azure 診断ログの概要][diagnostics-logs]」をご覧ください。

**AzureLogCollector 拡張機能を使用します。** (Windows VM のみ)この拡張機能は、オペレーターがリモートで VM にログを記録しなくても、Azure プラットフォームのログを集計し、それを Azure ストレージにアップロードします。 詳細については、「[AzureLogCollector 拡張機能](/azure/virtual-machines/virtual-machines-windows-log-collector-extension/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)」をご覧ください。

### <a name="virtual-network"></a>仮想ネットワーク

**パブリック IP アドレスをホワイトリストに登録したりブロックしたりするには、サブネットに NSG を追加します。** 悪意のあるユーザーからのアクセスをブロックしたり、アプリケーションにアクセスする権限を持つユーザーからのアクセスのみを許可したりしてください。  

**カスタムの正常性プローブを作成します。** ロード バランサー正常性プローブでは、HTTP または TCP のいずれかをテストできます。 VM が HTTP サーバーを実行している場合、HTTP プローブは TCP プローブよりも優れた正常性状態のインジケーターです。 HTTP プローブでは、すべての重要な依存関係を含む、アプリケーションの全体的な正常性をレポートするカスタム エンドポイントを使用してください。 詳細については、「 [Azure ロード バランサーの概要](/azure/load-balancer/load-balancer-overview/)」を参照してください。

**正常性プローブをブロックしないでください。** ロード バランサー正常性プローブは、既知の IP アドレスである 168.63.129.16 から送信されます。 任意のファイアウォール ポリシーまたはネットワーク セキュリティ グループ (NSG) の規則で、この IP を送受信するトラフィックをブロックしないでください。 正常性プローブをブロックすると、ロード バランサーによってローテーションから VM が削除されることがあります。

**ロード バランサーのログ記録を有効にします。** ログには、プローブの応答に失敗したことが原因で、ネットワーク トラフィックを受信していない、バックエンドの VM 数が表示されます。 詳細については、「[Azure Load Balancer のログ分析](/azure/load-balancer/load-balancer-monitor-log/)」をご覧ください。


<!-- links -->
[app-service-autoscale]: /azure/monitoring-and-diagnostics/insights-how-to-scale/
[asynchronous-c-sharp]: /dotnet/articles/csharp/async
[availability-sets]:/azure/virtual-machines/virtual-machines-windows-manage-availability/
[azure-backup]: https://azure.microsoft.com/documentation/services/backup/
[boot-diagnostics]: https://azure.microsoft.com/blog/boot-diagnostics-for-virtual-machines-v2/
[circuit-breaker]: ../patterns/circuit-breaker.md
[cloud-service-autoscale]: /azure/cloud-services/cloud-services-how-to-scale/
[diagnostics-logs]: /azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs/
[fma]: ../resiliency/failure-mode-analysis.md
[resilient-deployment]: ../resiliency/index.md#resilient-deployment
[load-balancer]: /azure/load-balancer/load-balancer-overview/
[managed-disks]: /azure/storage/storage-managed-disks-overview
[monitoring-and-diagnostics-guidance]: ../best-practices/monitoring.md
[resource-manager]: /azure/azure-resource-manager/resource-group-overview/
[retry-pattern]: ../patterns/retry.md
[retry-service-guidance]: ../best-practices/retry-service-specific.md
[search-optimization]: /azure/search/search-performance-optimization/
[sql-backup]: /azure/sql-database/sql-database-automated-backups/
[sql-restore]: /azure/sql-database/sql-database-recovery-using-backups/
[traffic-manager]: /azure/traffic-manager/traffic-manager-overview/
[traffic-manager-routing]: /azure/traffic-manager/traffic-manager-routing-methods/
[vm-manage-availability]: /azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set
[vmss-autoscale]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview/
