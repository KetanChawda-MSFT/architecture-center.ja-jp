---
title: 高可用性のネットワーク仮想アプライアンスをデプロイする
description: 高可用性のネットワーク仮想アプライアンスをデプロイする方法。
author: telmosampaio
ms.date: 12/06/2016
pnp.series.title: Network DMZ
pnp.series.prev: secure-vnet-dmz
cardTitle: Deploy highly available network virtual appliances
ms.openlocfilehash: fe279eea3f9cb024d6c6c14943013b9b9a87bc9c
ms.sourcegitcommit: e67b751f230792bba917754d67789a20810dc76b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2018
---
# <a name="deploy-highly-available-network-virtual-appliances"></a>高可用性のネットワーク仮想アプライアンスをデプロイする

この記事では、高可用性のネットワーク仮想アプライアンス (NVA) セットを Azure にデプロイする方法を示します。 NVA は、通常は、境界ネットワーク (DMZ とも呼ばれます) から他のネットワークまたはサブネットへのネットワーク トラフィックのフローを制御するために使用されます。 Azure での DMZ の実装については、「[Microsoft クラウド サービスとネットワーク セキュリティ][cloud-security]」を参照してください。 この記事には、イングレスのみ、エグレスのみ、イングレスとエグレスの両方を行うアーキテクチャの例が含まれています。 

<strong>前提条件:</strong> この記事は、Azure のネットワーク、[Azure ロード バランサー][lb-overview]、および[ユーザー定義ルート][udr-overview] (UDR) の基本的な知識があることを前提としています。 


## <a name="architecture-diagrams"></a>アーキテクチャ図

NVA は、さまざまなアーキテクチャの DMZ に配置できます。 たとえば、次の図は、イングレス用の[単一の NVA][nva-scenario] の使用を示しています。 

![[0]][0]

このアーキテクチャでは、NVA は、すべての着信ネットワーク トラフィックと発信ネットワーク トラフィックをチェックし、ネットワーク セキュリティ ルールを満たしているトラフィックのみを渡すことによって、セキュリティで保護されたネットワーク境界を提供します。 ただし、すべてのネットワーク トラフィックが NVA を通過する必要があるという事実は、NVA がネットワークの単一障害点であることを意味します。 この NVA で障害が発生した場合、ネットワーク トラフィック用の他のパスが存在しないため、すべてのバックエンド サブネットが使用不能になります。

NVA に高可用性を持たせるには、複数の NVA を可用性セットにデプロイします。    

以下のアーキテクチャは、高可用性の NVA で必要なリソースと構成について説明しています。

| 解決策 | メリット | 考慮事項 |
| --- | --- | --- |
| [第 7 層で NVA を使用するイングレス][ingress-with-layer-7] |すべての NVA ノードがアクティブ |接続を終了し SNAT を使用できる NVA が必要</br> インターネットからのトラフィックと Azure からのトラフィック用に別個の NVA セットが必要 </br> Azure の外部から発信されるトラフィックでのみ使用可能 |
| [第 7 層で NVA を使用するエグレス][egress-with-layer-7] |すべての NVA ノードがアクティブ | 接続を終了し、ソース ネットワーク アドレス変換 (SNAT) を実装できる NVA が必要
| [第 7 層で NVA を使用するイングレスとエグレス][ingress-egress-with-layer-7] |すべてのノードがアクティブ<br/>Azure で発信されたトラフィックを処理可能 |接続を終了し SNAT を使用できる NVA が必要<br/>インターネットからのトラフィックと Azure からのトラフィック用に別個の NVA セットが必要 |
| [PIP-UDR スイッチ][pip-udr-switch] |すべてのトラフィック用の単一の NVA セット<br/>すべてのトラフィックを処理可能 (ポート規則に制限なし) |アクティブ/パッシブ<br/>フェールオーバー プロセスが必要 |

## <a name="ingress-with-layer-7-nvas"></a>第 7 層で NVA を使用するイングレス

次の図は、インターネットに接続するロード バランサーの背後にイングレス DMZ を実装する高可用性アーキテクチャを示しています。 このアーキテクチャは、第 7 層のトラフィックで Azure ワークロードへの HTTP や HTTPS などの接続を提供するように設計されています。

![[1]][1]

このアーキテクチャの利点は、すべての NVA がアクティブであることであり、片方の NVA で障害が発生すると、ロード バランサーが他方の NVA にネットワーク トラフィックを送信します。 両方の NVA がトラフィックを内部ロード バランサーにルーティングするため、1 つの NVA がアクティブである限り、トラフィックが停止することはありません。 Web 層の VM を対象とする SSL トラフィックを終了するには、NVA が必要です。 オンプレミスのトラフィックには独自のネットワーク ルートを持つ NVA の別の専用セットが必要であるため、これらの NVA をオンプレミスのトラフィックを処理するように拡張することはできません。

> [!NOTE]
> このアーキテクチャは、[Azure とオンプレミスのデータセンターの間の DMZ][dmz-on-prem] リファレンス アーキテクチャと [ Azure とインターネットの間の DMZ][dmz-internet] リファレンス アーキテクチャで使用されています。 これらのリファレンス アーキテクチャのそれぞれに、使用できるデプロイ ソリューションが含まれています。 詳細については、リンクを参照してください。

## <a name="egress-with-layer-7-nvas"></a>第 7 層で NVA を使用するエグレス

前述のアーキテクチャを拡張して、Azure ワークロードから発信される要求を処理するエグレス DMZ を提供できます。 次のアーキテクチャは、DMZ 内の NVA に、HTTP や HTTPS などの第 7 層のトラフィックで高可用性を提供するように設計されています。

![[2]][2]

このアーキテクチャでは、Azure から発信されるすべてのトラフィックが内部ロード バランサーにルーティングされます。 ロード バランサーは、発信要求を NVA セットに分散します。 これらの NVA は、それぞれのパブリック IP アドレスを使用して、インターネットにトラフィックを送信します。

> [!NOTE]
> このアーキテクチャは、[Azure とオンプレミスのデータセンターの間の DMZ][dmz-on-prem] リファレンス アーキテクチャと [ Azure とインターネットの間の DMZ][dmz-internet] リファレンス アーキテクチャで使用されています。 これらのリファレンス アーキテクチャのそれぞれに、使用できるデプロイ ソリューションが含まれています。 詳細については、リンクを参照してください。

## <a name="ingress-egress-with-layer-7-nvas"></a>第 7 層で NVA を使用する イングレスとエグレス

前述の 2 つのアーキテクチャでは、イングレス用とエグレス用に別個の DMZ がありました。 次のアーキテクチャは、第 7 層のトラフィックで、HTTP や HTTPS などのイングレスとエグレスの両方で使用できる DMZ の作成方法を示しています。 

![[4]][4]

このアーキテクチャでは、NVA は、アプリケーション ゲートウェイから着信する要求を処理します。 NVA は、ロード バランサーのバックエンド プール内のワークロード VM から発信された要求も処理します。 着信トラフィックはアプリケーション ゲートウェイによってルーティングされ、発信トラフィックはロード バランサーによってルーティングされるため、NVA は、セッション アフィニティも担当します。 つまり、着信要求と発信要求のマッピングはアプリケーション ゲートウェイが管理するため、最初の要求元に適切な応答を転送できます。 ただし、内部ロード バランサーはアプリケーション ゲートウェイのマッピングにアクセスできないため、独自のロジックを使用して NVA への応答を送信します。 ロード バランサーは、アプリケーション ゲートウェイから要求を受信していない NVA に応答を送信する場合があります。 この場合、適切な NVA がアプリケーション ゲートウェイに応答を転送できるように、NVA 間で通信を行って応答を転送する必要があります。

> [!NOTE]
> NVA がインバウンドのソース ネットワーク アドレス変換 (SNAT) を確実に実行することで、非対称ルーティングの問題を解決することもできます。 これにより、要求元のソース IP が、インバウンド フローで使用される NVA のいずれかの IP アドレスに置き換えられます。 これで、ルートの対称性を維持しながら、一度に複数の NVA を使用できます。

## <a name="pip-udr-switch-with-layer-4-nvas"></a>第 4 層で NVA を使用する PIP-UDR の切り替え

次のアーキテクチャは、1 つのアクティブ NVA と 1 つのパッシブ NVA があるアーキテクチャを示しています。 このアーキテクチャでは、第 4 層のトラフィックでのイングレスとエグレスの両方を処理します。 

![[3]][3]

このアーキテクチャは、この記事で説明した最初のアーキテクチャに似ています。 そのアーキテクチャには、第 4 層の着信要求を受け取ってフィルター処理する単一の NVA が含まれていました。 このアーキテクチャでは、2 つ目のパッシブ NVA を追加して、高可用性を実現します。 アクティブ NVA で障害が発生した場合は、パッシブ NVA がアクティブになり、その時点でアクティブな NVA の NIC をポイントするように UDR と PIP が変更されます。 UDR と PIP に対するこれらの変更は、手動で実行するか、自動化されたプロセスを使用して実行できます。 自動化されたプロセスは、通常はデーモンまたは Azure で実行されている他の監視サービスです。 プロセスは、アクティブ NVA の正常性プローブをクエリし、NVA の障害を検出したときに、UDR と PIP の切り替えを実行します。 

上記の図は、高可用性デーモンがある [ZooKeeper][zookeeper] クラスターの例を示しています。 ZooKeeper クラスター内では、ノードのクォーラムがリーダーを選出します。 リーダーで障害が発生した場合は、残りのノードによって新しいリーダーが選出されます。 このアーキテクチャでは、リーダー ノードが、NVA の正常性エンドポイントをクエリするデーモンを実行します。 NVA が正常性プローブに応答できなければ、デーモンがパッシブ NVA をアクティブにします。 その後、デーモンは、Azure REST API を呼び出して、障害が発生した NVA から PIP を削除して新しくアクティブになった NVA にアタッチします。 次に、デーモンは、新しくアクティブになった NVA の内部 IP アドレスをポイントするように UDR を変更します。

> [!NOTE]
> NVA を含むルートを使用してのみアクセスできるサブネットに ZooKeeper ノードを配置しないでください。 配置すると、NVA で障害が発生した場合に ZooKeeper ノードにアクセスできなくなります。 デーモンが何らかの理由で失敗した場合に、ZooKeeper ノードにアクセスして問題を診断することができなくなります。 

<!--### Solution Deployment-->

<!-- instructions for deploying this solution here --> 

## <a name="next-steps"></a>次の手順
* 第 7 層の NVA を使用して [Azure とオンプレミスのデータセンターの間に DMZ を実装する][dmz-on-prem]方法を確認します。
* 第 7 層の NVA を使用して [Azure とインターネットの間に DMZ を実装する][dmz-internet]方法を確認します。

<!-- links -->
[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/

<!-- images -->
[0]: ./images/nva-ha/single-nva.png "単一 NVA アーキテクチャ"
[1]: ./images/nva-ha/l7-ingress.png "第 7 層のイングレス"
[2]: ./images/nva-ha/l7-ingress-egress.png "第 7 層のエグレス"
[3]: ./images/nva-ha/active-passive.png "アクティブ/パッシブ クラスター"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
