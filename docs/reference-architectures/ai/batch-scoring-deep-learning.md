---
title: ディープ ラーニング モデル用の Azure でのバッチ スコアリング
description: この参照アーキテクチャでは、Azure Batch AI を使用してニューラル スタイルの転送を動画に適用する方法を示します
author: jiata
ms.date: 10/02/2018
ms.author: jiata
ms.openlocfilehash: 1f3f3d3882b2b30eb29acd26c9eab9ff128028e2
ms.sourcegitcommit: 9eecff565392273d11b8702f1fcecb4d75e27a15
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/03/2018
ms.locfileid: "48243728"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="d8927-103">ディープ ラーニング モデル用の Azure でのバッチ スコアリング</span><span class="sxs-lookup"><span data-stu-id="d8927-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="d8927-104">この参照アーキテクチャでは、Azure Batch AI を使用してニューラル スタイルの転送を動画に適用する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="d8927-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="d8927-105">"*スタイルの転送*" とは、別の画像のスタイルに既存の画像を組み込むディープ ラーニングの手法です。</span><span class="sxs-lookup"><span data-stu-id="d8927-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="d8927-106">このアーキテクチャは、ディープ ラーニングでバッチ スコアリングを使用する任意のシナリオに一般化することができます。</span><span class="sxs-lookup"><span data-stu-id="d8927-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="d8927-107">[**このソリューションをデプロイします**](#deploy-the-solution)。</span><span class="sxs-lookup"><span data-stu-id="d8927-107">[**Deploy this solution**](#deploy-the-solution).</span></span>
 
![](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="d8927-108">**シナリオ**: あるメディア組織は、動画のスタイルを特定の絵画のように変更したいと考えています。</span><span class="sxs-lookup"><span data-stu-id="d8927-108">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="d8927-109">組織は、適切なタイミングで自動的に動画のすべてのフレームにこのスタイルを適用できることを望んでいます。</span><span class="sxs-lookup"><span data-stu-id="d8927-109">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="d8927-110">ニューラル スタイル転送アルゴリズムの背景について詳しくは、「[Image Style Transfer Using Convolutional Neural Networks][image-style-transfer]」(畳み込みニューラル ネットワークを使用した画像スタイルの転送) (PDF) をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="d8927-110">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="d8927-111">スタイル画像:</span><span class="sxs-lookup"><span data-stu-id="d8927-111">Style image:</span></span> | <span data-ttu-id="d8927-112">入力/コンテンツ動画:</span><span class="sxs-lookup"><span data-stu-id="d8927-112">Input/content video:</span></span> | <span data-ttu-id="d8927-113">出力動画:</span><span class="sxs-lookup"><span data-stu-id="d8927-113">Output video:</span></span> | 
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="d8927-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "入力動画") *クリックすると動画が表示されます*</span><span class="sxs-lookup"><span data-stu-id="d8927-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="d8927-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "出力動画") *クリックすると動画が表示されます*</span><span class="sxs-lookup"><span data-stu-id="d8927-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="d8927-116">この参照アーキテクチャは、Azure Storage に新しいメディアが存在することによってトリガーされるワークロード用に設計されています。</span><span class="sxs-lookup"><span data-stu-id="d8927-116">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="d8927-117">処理には次の手順が含まれます。</span><span class="sxs-lookup"><span data-stu-id="d8927-117">Processing involves the following steps:</span></span>

1. <span data-ttu-id="d8927-118">選択したスタイル画像 (ゴッホの絵など) とスタイル転送スクリプトを、Blob Storage にアップロードします。</span><span class="sxs-lookup"><span data-stu-id="d8927-118">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="d8927-119">処理を開始する準備ができている自動スケール Batch AI クラスターを作成します。</span><span class="sxs-lookup"><span data-stu-id="d8927-119">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="d8927-120">動画ファイルを個々のフレームに分割し、それらのフレームを Blob Storage にアップロードします。</span><span class="sxs-lookup"><span data-stu-id="d8927-120">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="d8927-121">すべてのフレームがアップロードされたら、トリガー ファイルを Blob Storage にアップロードします。</span><span class="sxs-lookup"><span data-stu-id="d8927-121">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="d8927-122">このファイルは、Azure Container Instances 内で実行されるコンテナーを作成するロジック アプリをトリガーします。</span><span class="sxs-lookup"><span data-stu-id="d8927-122">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="d8927-123">コンテナーで、Batch AI ジョブを作成するスクリプトが実行されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-123">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="d8927-124">各ジョブで、Batch AI クラスターのノード間に並列にニューラル スタイル転送が適用されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-124">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="d8927-125">イメージが生成されると、Blob Storage に保存されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-125">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="d8927-126">生成されたフレームをダウンロードして、画像を動画に合成します。</span><span class="sxs-lookup"><span data-stu-id="d8927-126">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="d8927-127">アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="d8927-127">Architecture</span></span>
<span data-ttu-id="d8927-128">このアーキテクチャは、次のコンポーネントで構成されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-128">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="d8927-129">コンピューティング</span><span class="sxs-lookup"><span data-stu-id="d8927-129">Compute</span></span>

<span data-ttu-id="d8927-130">**[Azure Batch AI][batch-ai]** は、ニューラル スタイル転送アルゴリズムを実行するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-130">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="d8927-131">Batch AI は、GPU 対応の VM でディープ ラーニング フレームワーク用にあらかじめ構成されているコンテナー化された環境を提供することにより、ディープ ラーニング ワークロードをサポートします。</span><span class="sxs-lookup"><span data-stu-id="d8927-131">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="d8927-132">Batch AI は、BLOB ストレージにコンピューティング クラスターを接続することもできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-132">Batch AI can also connect the compute cluster to Blob storage.</span></span>

### <a name="storage"></a><span data-ttu-id="d8927-133">Storage</span><span class="sxs-lookup"><span data-stu-id="d8927-133">Storage</span></span>

<span data-ttu-id="d8927-134">**[BLOB ストレージ][blob-storage]** は、すべての画像 (入力画像、スタイル画像、出力画像) および Batch AI から生成されるすべてのログを格納するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-134">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="d8927-135">BLOB ストレージは、BLOB ストレージでサポートされるオープン ソースの仮想ファイル システムである [blobfuse][blobfuse] を使用して、Batch AI と統合されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-135">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="d8927-136">BLOB ストレージは、このワークロードに必要なパフォーマンスに対してコスト効率も非常に優れています。</span><span class="sxs-lookup"><span data-stu-id="d8927-136">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="d8927-137">トリガー/スケジュール</span><span class="sxs-lookup"><span data-stu-id="d8927-137">Trigger / scheduling</span></span>

<span data-ttu-id="d8927-138">**[Azure Logic Apps][logic-apps]** は、ワークフローをトリガーするために使用されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-138">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="d8927-139">Logic Apps は、コンテナーに BLOB が追加されたことを検出すると、Batch AI プロセスをトリガーします。</span><span class="sxs-lookup"><span data-stu-id="d8927-139">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="d8927-140">Logic Apps は、BLOB ストレージに対する変更を検出する簡単な方法であり、トリガーを変更するための簡単なプロセスを備えているため、この参照アーキテクチャに非常に適しています。</span><span class="sxs-lookup"><span data-stu-id="d8927-140">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="d8927-141">**[Azure Container Instances][container-instances]** は、Batch AI ジョブを作成する Python スクリプトを実行するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-141">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="d8927-142">Docker コンテナー内でこれらのスクリプトを実行することは、オンデマンドでスクリプトを実行する便利な方法です。</span><span class="sxs-lookup"><span data-stu-id="d8927-142">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="d8927-143">このアーキテクチャでは、Container Instances 用の構築済みのロジック アプリ コネクタがあるため、Container Instances を使用します。これにより、ロジック アプリは Batch AI ジョブをトリガーできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-143">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="d8927-144">Container Instances は、ステートレス プロセスを迅速に開始できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-144">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="d8927-145">**[DockerHub][dockerhub]** は、Container Instances がジョブ作成プロセスの実行に使用する Docker イメージを格納するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-145">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="d8927-146">DockerHub は、使いやすく、Docker ユーザーに対する既定のイメージ リポジトリであるため、このアーキテクチャに選択されました。</span><span class="sxs-lookup"><span data-stu-id="d8927-146">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="d8927-147">[Azure Container Registry][container-registry] を使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-147">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="d8927-148">データの準備</span><span class="sxs-lookup"><span data-stu-id="d8927-148">Data preparation</span></span>

<span data-ttu-id="d8927-149">この参照アーキテクチャでは、木の中にいるオランウータンの動画映像を使用します。</span><span class="sxs-lookup"><span data-stu-id="d8927-149">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="d8927-150">[こちら][source-video]から映像をダウンロードし、次の手順に従ってワークフロー用に処理できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-150">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="d8927-151">[AzCopy][azcopy] を使用して、パブリック BLOB から動画をダウンロードします。</span><span class="sxs-lookup"><span data-stu-id="d8927-151">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="d8927-152">[FFmpeg][ffmpeg] を使用してオーディオ ファイルを抽出し、後で出力動画にオーディオ ファイルを合成できるようにします。</span><span class="sxs-lookup"><span data-stu-id="d8927-152">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="d8927-153">FFmpeg を使用して、動画を個々のフレームに分割します。</span><span class="sxs-lookup"><span data-stu-id="d8927-153">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="d8927-154">フレームは、並列で個別に処理されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-154">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="d8927-155">AzCopy を使用して、個々のフレームを BLOB コンテナーにコピーします。</span><span class="sxs-lookup"><span data-stu-id="d8927-155">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="d8927-156">この段階で、動画映像はニューラル スタイル転送に使用できる形式になっています。</span><span class="sxs-lookup"><span data-stu-id="d8927-156">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span> 

## <a name="performance-considerations"></a><span data-ttu-id="d8927-157">パフォーマンスに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="d8927-157">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="d8927-158">GPU と CPU</span><span class="sxs-lookup"><span data-stu-id="d8927-158">GPU vs CPU</span></span>

<span data-ttu-id="d8927-159">ディープ ラーニング ワークロードでは、同等のパフォーマンスを得るためには非常に大規模な CPU クラスターが必要になるため、一般に、CPU より GPU の方がかなり優れています。</span><span class="sxs-lookup"><span data-stu-id="d8927-159">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="d8927-160">このアーキテクチャでは CPU のみを使用することもできますが、GPU の方が優れたコスト/パフォーマンス プロファイルを提供します。</span><span class="sxs-lookup"><span data-stu-id="d8927-160">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="d8927-161">GPU 最適化 VM の最新の [NCv3 シリーズ]vm-sizes-gpu を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="d8927-161">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="d8927-162">すべてのリージョンで、GPU は既定では有効になっていません。</span><span class="sxs-lookup"><span data-stu-id="d8927-162">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="d8927-163">GPU が有効になっているリージョンを選択してください。</span><span class="sxs-lookup"><span data-stu-id="d8927-163">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="d8927-164">さらに、サブスクリプションの既定のクォータでは、GPU 最適化 VM のコア数は 0 です。</span><span class="sxs-lookup"><span data-stu-id="d8927-164">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="d8927-165">サポート要求を開くことで、このクォータを増やすことができます。</span><span class="sxs-lookup"><span data-stu-id="d8927-165">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="d8927-166">ワークロードを実行するための十分なクォータがサブスクリプションにあることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="d8927-166">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="d8927-167">VM とコアの間の並列化</span><span class="sxs-lookup"><span data-stu-id="d8927-167">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="d8927-168">スタイル転送プロセスをバッチ ジョブとして実行するとき、主に GPU 上で実行されるジョブは、VM 間で並列化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-168">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="d8927-169">2 つの方法が可能であり、単一の GPU を備えた VM を使用して大規模なクラスターを作成するか、または多くの GPU を備えた VM を使用して小規模なクラスターを作成することができます。</span><span class="sxs-lookup"><span data-stu-id="d8927-169">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span> 

<span data-ttu-id="d8927-170">このワークロードでは、これら 2 つのオプションのパフォーマンスは同等です。</span><span class="sxs-lookup"><span data-stu-id="d8927-170">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="d8927-171">VM あたりの GPU が多い少数の VM を使用すると、データ移動を削減するのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="d8927-171">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="d8927-172">ただし、このワークロードではジョブごとのデータ量がそれほど多くないので、BLOB ストレージによって大きく制限されることはありません。</span><span class="sxs-lookup"><span data-stu-id="d8927-172">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="d8927-173">Batch AI ジョブごとの画像バッチ サイズ</span><span class="sxs-lookup"><span data-stu-id="d8927-173">Images batch size per Batch AI job</span></span>

<span data-ttu-id="d8927-174">構成する必要があるもう 1 つのパラメーターは、Batch AI ジョブごとに処理する画像の数です。</span><span class="sxs-lookup"><span data-stu-id="d8927-174">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="d8927-175">一方では、処理をノード間に広く分散させ、ジョブが失敗した場合に再処理する必要のある画像が多くなりすぎないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-175">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="d8927-176">そのためには、多数の Batch AI ジョブを使用して、ジョブごとに処理する画像の数を減らします。</span><span class="sxs-lookup"><span data-stu-id="d8927-176">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="d8927-177">しかし他方では、ジョブごとに処理される画像が少なすぎると、セットアップ/起動時間が不釣り合いに大きくなります。</span><span class="sxs-lookup"><span data-stu-id="d8927-177">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="d8927-178">ジョブの数を、クラスター内のノードの最大数と等しくなるように設定することができます。</span><span class="sxs-lookup"><span data-stu-id="d8927-178">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="d8927-179">このようにすると、セットアップ/起動コストの量が最小限になるため、ジョブが失敗しなければ、パフォーマンスは最大になります。</span><span class="sxs-lookup"><span data-stu-id="d8927-179">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="d8927-180">ただし、ジョブが失敗した場合は、多数の画像の再処理が必要になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-180">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="d8927-181">ファイル サーバー</span><span class="sxs-lookup"><span data-stu-id="d8927-181">File servers</span></span>

<span data-ttu-id="d8927-182">Batch AI を使用する場合は、シナリオに必要なスループットに応じて、複数のストレージ オプションを選択できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-182">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="d8927-183">必要なスループットが低いワークロードでは、(blobfuse を介して) BLOB を使用するので十分なはずです。</span><span class="sxs-lookup"><span data-stu-id="d8927-183">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="d8927-184">または、Batch AI では管理された単一ノード NFS である Batch AI ファイル サーバーもサポートされており、クラスター ノードに自動的にマウントされて、ジョブに対して一元的にアクセス可能なストレージの場所を提供できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-184">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="d8927-185">ほとんどの場合、ワークスペースで必要なファイル サーバーは 1 つだけであり、トレーニング ジョブのデータを異なるディレクトリに分離することができます。</span><span class="sxs-lookup"><span data-stu-id="d8927-185">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="d8927-186">単一ノードの NFS がワークロードに適していない場合、Batch AI では、Azure Files または Gluster や Lustre ファイル システムといったカスタム ソリューションなど、他のストレージ オプションがサポートされています。</span><span class="sxs-lookup"><span data-stu-id="d8927-186">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="d8927-187">セキュリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="d8927-187">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="d8927-188">Azure Blob Storage へのアクセスの制限</span><span class="sxs-lookup"><span data-stu-id="d8927-188">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="d8927-189">この参照アーキテクチャでは、Azure Blob Storage が保護する必要のあるメイン ストレージ コンポーネントです。</span><span class="sxs-lookup"><span data-stu-id="d8927-189">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="d8927-190">GitHub リポジトリで示されているベースライン展開では、ストレージ アカウント キーを使用して BLOB ストレージにアクセスしています。</span><span class="sxs-lookup"><span data-stu-id="d8927-190">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="d8927-191">さらに制御と保護を強化するには、共有アクセス署名 (SAS) を代わりに使用することを検討します。</span><span class="sxs-lookup"><span data-stu-id="d8927-191">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="d8927-192">これは、ストレージ内のオブジェクトへの制限されたアクセスを付与し、アカウント キーをハード コーディングしたり、それをプレーンテキストで保存したりする必要はありません。</span><span class="sxs-lookup"><span data-stu-id="d8927-192">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="d8927-193">ロジック アプリのデザイナー インターフェイスの内部ではアカウント キーがプレーンテキストで表示されるので、このアプローチは特に便利です。</span><span class="sxs-lookup"><span data-stu-id="d8927-193">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="d8927-194">SAS を使用すると、ストレージ アカウントに適切なガバナンスがあること、およびアクセス権がそれを必要とするユーザーだけに付与されることを保証するのにも役立ちます。</span><span class="sxs-lookup"><span data-stu-id="d8927-194">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="d8927-195">ストレージ キーはワークロードのすべての入出力データに対するフル アクセス権を与えるため、データの機密性がさらに高いシナリオでは、すべてのストレージ キーが保護されるようにします。</span><span class="sxs-lookup"><span data-stu-id="d8927-195">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="d8927-196">データの暗号化とデータの移動</span><span class="sxs-lookup"><span data-stu-id="d8927-196">Data encryption and data movement</span></span>

<span data-ttu-id="d8927-197">この参照アーキテクチャでは、バッチ スコアリング プロセスの例として、スタイルの転送を使用しています。</span><span class="sxs-lookup"><span data-stu-id="d8927-197">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="d8927-198">データの機密性がさらに高いシナリオでは、ストレージに保存されているときのデータを暗号化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-198">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="d8927-199">データがある場所から次の場所に移動されるたびに、SSL を使用してデータ転送をセキュリティ保護します。</span><span class="sxs-lookup"><span data-stu-id="d8927-199">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="d8927-200">詳しくは、「[Azure Storage セキュリティ ガイド][storage-security]」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="d8927-200">For more information, see [Azure Storage security guide][storage-security].</span></span> 

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="d8927-201">仮想ネットワーク内のデータのセキュリティ保護</span><span class="sxs-lookup"><span data-stu-id="d8927-201">Securing data in a virtual network</span></span>

<span data-ttu-id="d8927-202">Batch AI クラスターを展開するときは、仮想ネットワークのサブネット内にプロビジョニングされるようにクラスターを構成できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-202">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="d8927-203">これにより、クラスター内のコンピューティング ノードは、他の仮想マシンや、オンプレミスのネットワークとさえ、安全に通信できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-203">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="d8927-204">また、BLOB ストレージで[サービス エンドポイント][service-endpoints]を使用して仮想ネットワークからのアクセスを許可したり、Batch AI の VNET 内で単一ノード NFS を使用して、データが常に保護されるようにすることもできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-204">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="d8927-205">悪意のあるアクティビティからの保護</span><span class="sxs-lookup"><span data-stu-id="d8927-205">Protecting against malicious activity</span></span>

<span data-ttu-id="d8927-206">複数のユーザーがいるシナリオでは、機密データが悪意のあるアクティビティに対して保護されるようにします。</span><span class="sxs-lookup"><span data-stu-id="d8927-206">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="d8927-207">この展開にアクセスして入力データをカスタマイズすることを他のユーザーに許可する場合は、次の注意事項と考慮事項に留意します。</span><span class="sxs-lookup"><span data-stu-id="d8927-207">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="d8927-208">RBAC を使用して、ユーザーのアクセスを必要なリソースのみに制限します。</span><span class="sxs-lookup"><span data-stu-id="d8927-208">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="d8927-209">2 つのストレージ アカウントを個別にプロビジョニングします。</span><span class="sxs-lookup"><span data-stu-id="d8927-209">Provision two separate storage accounts.</span></span> <span data-ttu-id="d8927-210">1 つのアカウントで、入力と出力のデータを格納します。</span><span class="sxs-lookup"><span data-stu-id="d8927-210">Store input and output data in the first account.</span></span> <span data-ttu-id="d8927-211">外部ユーザーにはこのアカウントへのアクセスを許可できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-211">External users can be given access to this account.</span></span> <span data-ttu-id="d8927-212">もう 1 つのアカウントには、実行可能なスクリプトと出力ログ ファイルを格納します。</span><span class="sxs-lookup"><span data-stu-id="d8927-212">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="d8927-213">外部ユーザーはこのアカウントにアクセスできないようにします。</span><span class="sxs-lookup"><span data-stu-id="d8927-213">External users should not have access to this account.</span></span> <span data-ttu-id="d8927-214">このようにすると、外部ユーザーは実行可能ファイルを変更 (して悪意のあるコードを挿入) することができず、機密情報が保持されている可能性があるログ ファイルにアクセスできません。</span><span class="sxs-lookup"><span data-stu-id="d8927-214">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="d8927-215">悪意のあるユーザーは、ジョブ キューに対して DDOS を行ったり、不正な形式の有害なメッセージをジョブ キューに挿入したりして、システムをロックさせたりデキュー エラーを発生させたりする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-215">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span> 

## <a name="monitoring-and-logging"></a><span data-ttu-id="d8927-216">監視およびログ記録</span><span class="sxs-lookup"><span data-stu-id="d8927-216">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="d8927-217">Batch AI ジョブの監視</span><span class="sxs-lookup"><span data-stu-id="d8927-217">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="d8927-218">ジョブの実行中は、進行状況を監視し、想定どおりに動作していることを確認することが重要です。</span><span class="sxs-lookup"><span data-stu-id="d8927-218">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="d8927-219">ただし、アクティブなノードのクラスター全体を監視するのは困難な場合があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-219">However, it can be a challenge to monitor across a cluster of active nodes.</span></span> 

<span data-ttu-id="d8927-220">クラスターの全体的な状態を把握するには、Azure Portal の Batch AI ブレードに移動して、クラスター内のノードの状態を検査します。</span><span class="sxs-lookup"><span data-stu-id="d8927-220">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="d8927-221">ノードが非アクティブになった場合、またはジョブが失敗した場合は、エラー ログが BLOB ストレージに保存されており、Azure Portal の [ジョブ] ブレードでもアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-221">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span> 

<span data-ttu-id="d8927-222">ログを Application Insights に接続することで、または別のプロセスを実行して Batch AI クラスターとそのジョブの状態をポーリングすることで、監視をさらに強化できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-222">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="d8927-223">Batch AI でのログ</span><span class="sxs-lookup"><span data-stu-id="d8927-223">Logging in Batch AI</span></span>

<span data-ttu-id="d8927-224">Batch AI は、関連付けられている BLOB ストレージ アカウントに、すべての stdout/stderr を自動的に記録します。</span><span class="sxs-lookup"><span data-stu-id="d8927-224">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="d8927-225">Storage Explorer などのストレージ ナビゲーション ツールを使用すると、ログ ファイルをナビゲートするエクスペリエンスがはるかに簡単になります。</span><span class="sxs-lookup"><span data-stu-id="d8927-225">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span> 

<span data-ttu-id="d8927-226">この参照アーキテクチャの展開の手順では、さらに簡単なログ記録システムをセットアップする方法も示されています。このシステムでは、次に示すように、さまざまなジョブ全体のすべてのログが、BLOB コンテナー内の同じディレクトリに保存されます。</span><span class="sxs-lookup"><span data-stu-id="d8927-226">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span>
<span data-ttu-id="d8927-227">これらのログを使用して、各ジョブおよび各画像の処理にかかった時間を監視します。</span><span class="sxs-lookup"><span data-stu-id="d8927-227">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="d8927-228">このようにすると、プロセスをさらに最適化するのにいっそうよい方法を思い付くことができます。</span><span class="sxs-lookup"><span data-stu-id="d8927-228">This will give you a better sense of how to optimize the process even further.</span></span>

![](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="d8927-229">コストに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="d8927-229">Cost considerations</span></span>

<span data-ttu-id="d8927-230">コストの点では、この参照アーキテクチャで使用されているコンピューティング リソースは、ストレージおよびスケジュール コンポーネントより、はるかに大きい部分を占めます。</span><span class="sxs-lookup"><span data-stu-id="d8927-230">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="d8927-231">主要な課題の 1 つは、GPU 対応マシンのクラスター全体に作業を効果的に並列化することです。</span><span class="sxs-lookup"><span data-stu-id="d8927-231">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="d8927-232">Batch AI クラスターのサイズは、キュー内のジョブに応じて、自動的にスケールアップおよびスケールダウンできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-232">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="d8927-233">2 つの方法のいずれかで、Batch AI の自動スケールを有効にできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-233">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="d8927-234">プログラムで行う場合は、[展開手順][deployment]の一部である `.env` ファイルで構成できます。または、クラスターを作成した後、ポータルで直接スケール式を変更することもできます。</span><span class="sxs-lookup"><span data-stu-id="d8927-234">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="d8927-235">即時処理を必要としない作業の場合は、既定の状態 (最小) が 0 個のノードのクラスターであるように、自動スケールの式を構成します。</span><span class="sxs-lookup"><span data-stu-id="d8927-235">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="d8927-236">この構成では、クラスターは 0 個のノードで開始し、キュー内でジョブが検出されたときのみスケールアップします。</span><span class="sxs-lookup"><span data-stu-id="d8927-236">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="d8927-237">バッチ スコアリング プロセスが 1 日に数回以下しか発生しない場合は、この設定により大幅なコスト削減を実現できます。</span><span class="sxs-lookup"><span data-stu-id="d8927-237">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="d8927-238">非常に短い間隔で発生するバッチ ジョブでは、自動スケールが適切ではない場合があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-238">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="d8927-239">クラスターの起動と停止に要する時間にもコストがかかるので、前のジョブの終了後ほんの数分でバッチ ワークロードが開始する場合は、ジョブ間もクラスターを実行したままにする方がコスト効率がよくなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d8927-239">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="d8927-240">ソリューションのデプロイ方法</span><span class="sxs-lookup"><span data-stu-id="d8927-240">Deploy the solution</span></span>

<span data-ttu-id="d8927-241">この参照アーキテクチャを展開するには、[GitHub リポジトリ][deployment]で説明されている手順に従ってください。</span><span class="sxs-lookup"><span data-stu-id="d8927-241">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu