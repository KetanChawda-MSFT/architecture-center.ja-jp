---
title: "イベント ドリブン アーキテクチャのスタイル"
description: "Azure でのイベント ドリブン アーキテクチャと IoT アーキテクチャのメリット、課題、ベスト プラクティスを説明します"
author: MikeWasson
ms.openlocfilehash: 3289bf784b02d62e3d0c1a29b4839c9be3501134
ms.sourcegitcommit: 3d9ee03e2dda23753661a80c7106d1789f5223bb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/23/2018
---
# <a name="event-driven-architecture-style"></a>イベント ドリブン アーキテクチャのスタイル

イベント ドリブン アーキテクチャは、イベントのストリームを生成する**イベント プロデューサー**と、イベントをリッスンする**イベント コンシューマー**で構成されます。 

![](./images/event-driven.svg)

イベントはほぼリアルタイムで配信されるため、イベントが発生するとコンシューマーはすぐに応答できます。 プロデューサーはコンシューマーから分離されており、&mdash;プロデューサーにはどのコンシューマーがリッスンしているのかがわかりません。 コンシューマーも互いに分離されており、すべてのコンシューマーがすべてのイベントを見ることができます。 これは[競合コンシューマー][competing-consumers] パターンとは異なり、コンシューマーがキューからメッセージを取得し、メッセージは一度だけ処理されます (エラーは想定されません)。 IoT などの一部のシステムでは、イベントを大量に取り込む必要があります。

イベント ドリブン アーキテクチャでは、パブリッシュ/サブスクライブ モデルやイベント ストリーム モデルを使用できます。 

- **パブリッシュ/サブスクライブ**: メッセージング インフラストラクチャはサブスクリプションを追跡し続けます。 イベントが発行されると、各サブスクライバーにイベントが送信されます。 イベントの受信後は、イベントを再生することはできません。また、そのイベントは新しいサブスクライバーに表示されません。 

- **イベント ストリーミング**: イベントがログに書き込まれます。 イベントは (パーティション内で) 厳密に順序付けされ、持続します。 クライアントはストリームにサブスクライブしませんが、その代わり、ストリームのどの部分からでも読み取ることができます。 ストリーム内でクライアントの位置を進めるのは、クライアントの役割です。 つまりクライアントはいつでも参加でき、イベントを再生できます。

コンシューマー側には、いくつかの一般的なバリエーションがあります。

- **簡単なイベント処理**。 イベントがコンシューマーのアクションを即時トリガーします。 たとえば、お客様は Service Bus トリガーを備えた Azure Functions を使用でき、それにより、Service Bus トピックにメッセージが発行されるたびに関数が実行されます。

- **複合イベント処理**。 コンシューマーは一連のイベントを処理し、Azure Stream Analytics または Apache Storm などのテクノロジを使用してイベント データのパターンを検索します。 たとえば、組み込みデバイスからの測定値を時間枠で集計し、移動平均が特定のしきい値を超えた場合に通知を生成することができます。 

- **イベント ストリーム処理**. Azure IoT Hub や Apache Kafka などのデータ ストリーミング プラットフォームを、イベントを取り込んでストリーム プロセッサにフィードするパイプラインとして使用します。 ストリーム プロセッサは、ストリームの処理や変換を行います。 アプリケーションの異なるサブシステムに対して、複数のストリーム プロセッサが存在する場合があります。 この手法は IoT ワークロードに適しています。

イベントのソースはシステムの外部にある場合があります。たとえば、IoT ソリューションの物理デバイスなどです。 その場合、システムはデータ ソースで必要なボリュームとスループットでデータを取り込むことができる必要があります。

上記の図では、コンシューマーが種類ごとに 1 つのボックスで表示されています。 実際には、1 つのコンシューマーに複数のインスタンスがあるのが一般的ですが、それはコンシューマーがシステムの単一障害点にならないようにするためです。 イベントのボリュームと頻度を制御するのに、複数のインスタンスが必要になることもあります。 また、1 つのコンシューマーが複数のスレッドのイベントを処理することもあります。 イベントを順番に処理しなければならない、または正確に 1 回のセマンティクスが必要な場合には、このために課題が発生することがあります。 [「Minimize Coordination (調整を最小限に抑える)」][minimize-coordination]をご覧ください。 

## <a name="when-to-use-this-architecture"></a>このアーキテクチャを使用する状況

- 複数のサブシステムで同じイベントを処理する必要がある。 
- 最小のタイム ラグのリアルタイム処理。
- パターン マッチングや時間枠での集計などの複合イベント処理。
- IoT などの高ボリューム、高ベロシティのデータ。

## <a name="benefits"></a>メリット

- プロデューサーとコンシューマーが分離。
- ポイント ツー ポイント統合でない。 システムに新しいコンシューマーを追加するのが簡単。
- コンシューマーは、イベントが到着するとすぐに応答可能。 
- 高い拡張性と分散。 
- サブシステムにイベント ストリームの独立したビューがある。

## <a name="challenges"></a>課題

- 保証された配信。 一部のシステムでは (特に IoT シナリオで)、イベントが配信されたことを保証することが重要です。
- イベントを順番に、または正確に 1 回処理。 各コンシューマー タイプは通常、回復性とスケーラビリティのために複数のインスタンスで実行されます。 (コンシューマー タイプ内で) 順番にイベントを処理する必要がある場合や、処理ロジックがべき等でない場合は、このために課題が発生することがあります。

## <a name="iot-architecture"></a>IoT アーキテクチャ

イベント ドリブン アーキテクチャは、IoT ソリューションにとって重要です。 次の図は、IoT で考えられる論理アーキテクチャを示しています。 この図では、アーキテクチャのイベント ストリーミング コンポーネントが強調されています。

![](./images/iot.png)

**クラウド ゲートウェイ**が、信頼性の高い低待機時間のメッセージング システムを使用して、クラウドの境界でデバイスのイベントを取り込みます。

デバイスは、クラウド ゲートウェイに直接イベントを送信するか、**フィールド ゲートウェイ**を介して送信します。 フィールド ゲートウェイは特殊なデバイスまたはソフトウェアで、通常はデバイスと共に配置され、イベントを受信してクラウド ゲートウェイに転送します。 フィールド ゲートウェイは、フィルター処理、集計、またはプロトコルの変換などの関数を実行する、ロウ デバイス イベントの前処理を行うこともあります。

取り込み後、イベントは 1 つ以上の**ストリーム プロセッサ**を経由します。それらのプロセッサは、データをルーティングしたり (ストレージへのルーティングなど)、分析やその他の処理を実行したりできます。

一般的な処理の種類を次に示します。 (このリストは全てを網羅しているわけではありません。)

- アーカイブまたはバッチ分析のための、コールド ストレージへのイベント データの書き込み。

- イベント ストリームを (ほぼ) リアルタイムで分析するホット パス分析で異常を検出し、ローリング時間枠でパターンを認識し、ストリームで特定の条件が発生した場合にアラートをトリガーする。 

- 通知やアラームなど、デバイスからの特殊な非テレメトリ メッセージを処理。 

- 機械学習。

網掛けのグレーのボックスに、IoT システムのコンポーネントが表示されています。これらのコンポーネントはイベント ストリーミングに直接関連はありませんが、ここでは完全を期すために盛り込んでいます。

- **デバイス レジストリ**はプロビジョニングされたデバイスのデータベースで、デバイス ID と、通常は位置情報などのデバイスのメタデータを含みます。

- **プロビジョニング API** は新しいデバイスをプロビジョニングし登録するための一般的な外部インターフェイスです。

- 一部の IoT ソリューションでは、**コマンドやコントロール メッセージ**をデバイスに送信できます。

> このセクションでは IoT の概要について示しましたが、考慮すべき詳細や課題は多数あります。 さらに詳細な参照アーキテクチャやディスカッションについては、「[Microsoft Azure IoT Reference Architecture (Microsoft Azure IoT 参照アーキテクチャ)][iot-ref-arch]」 (PDF ダウンロード) をご覧ください。

 <!-- links -->

[competing-consumers]: ../../patterns/competing-consumers.md
[iot-ref-arch]: https://azure.microsoft.com/updates/microsoft-azure-iot-reference-architecture-available/
[minimize-coordination]: ../design-principles/minimize-coordination.md


