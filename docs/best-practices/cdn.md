---
title: "Content Delivery Network のガイダンス"
description: "コンテンツ配信ネットワーク (CDN) で Azure でホストされている広帯域幅コンテンツを配信するためのガイダンス"
author: dragon119
ms.date: 09/30/2016
pnp.series.title: Best Practices
ms.openlocfilehash: 94036c803552d5e7061f99e6dd0ca9e563a32690
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/14/2017
---
# <a name="content-delivery-network"></a>Content Delivery Network
[!INCLUDE [header](../_includes/header.md)]

Microsoft Azure Content Delivery Network (CDN) は、Azure または他の任意の場所でホストされている高帯域幅コンテンツを配信するためのグローバル ソリューションを開発者に提供します。 CDN を使用すると、Azure BLOB ストレージ、Web アプリケーション、仮想マシン、アプリケーション フォルダー、またはその他の HTTP/HTTPS の場所から読み込んだ一般公開されているオブジェクトをキャッシュすることができます。 CDN のキャッシュを戦略的な場所に配置することで、ユーザーへのコンテンツ配信に最大限の帯域幅を提供することができます。 CDN は、通常、イメージ、スタイル シート、ドキュメント、ファイル、クライアント側スクリプトでは、HTML ページなどの静的コンテンツの配信に使用されます。

PDF レポートまたは指定の入力に基づくグラフなどの動的なコンテンツを提供するためのキャッシュとして CDN を使用することもできます。複数の異なるユーザーによって同じ入力値が指定された場合、結果は同じになる必要があります。

CDN を使用する主な利点は、アプリケーションがホストされているデータセンターに対してユーザー位置する地理的な場所に関係なく、コンテンツをユーザーに短い待ち時間で高速配信できることです。  

![CDN の図](./images/cdn/CDN.png)

CDN を使用すると、アプリケーションはコンテンツにアクセスおよびコンテンツを配信するのに必要な処理から解放されるため、アプリケーションでの負荷の軽減にも有効です。 負荷が軽減されることで、アプリケーションのパフォーマンスとスケーラビリティが向上します。また、一定レベルのパフォーマンスと可用性を達成するために必要な処理リソースが削減されるので、ホスト用のコストも最小限に抑えられます。

## <a name="how-and-why-a-cdn-is-used"></a>CDN の使用方法と使用する理由
CDN の一般的な用途は次のとおりです。  

* クライアント アプリケーション用の静的リソースの配信 (多くの場合、Web サイトから)。 静的リソースとは、たとえば、イメージ、スタイル シート、ドキュメント、ファイル、クライアント側スクリプト、HTML ページ、HTML フラグメントなど、個々の要求に応じてサーバー側が変更する必要がないコンテンツです。 アプリケーションでは、実行時にアイテムを作成し、CDN から使用できるようにすることもできますが (たとえば、最新ニュースの見出し一覧を作成するなど)、個々の要求に応じて実行することはありません。
* 静的な共有パブリック コンテンツを携帯電話やタブレット コンピューターなどのデバイスに配信する。 アプリケーション自体は、さまざまなデバイス上で実行されているクライアントに API を提供する Web サービスです。 CDN は、クライアント UI の生成などの目的で、クライアントが使用する静的データセットを配信することもできます (Web サービスを介して)。 たとえば、JSON または XML ドキュメントの配信に CDN を使用することができます。
* 専用のコンピューティング リソースを使用することなく、静的パブリック コンテンツのみで構成されている Web サイト全体をクライアントに提供。
* オンデマンドでビデオ ファイルをクライアントにストリーミング。 ビデオの場合、CDN 接続を提供するデータセンターは世界各国にあるため、短い待機時間、信頼性の高い接続という利点があります。 Microsoft Azure Media Services (AMS) は、CDN に直接コンテンツを配信し、そこからさらに配信するために Azure CDN と統合されています。 詳しくは、「[ストリーミング エンドポイントの概要](/azure/media-services/media-services-streaming-endpoints-overview)」をご覧ください。
* ユーザーのエクスペリエンスを全般的に改善 (特に、アプリケーションをホストしているデータセンターから離れた場所で利用しているユーザー)。 そのようなユーザーの場合、他の方法では、待機時間が長くなる場合があります。 多くの場合、Web アプリケーションに含まれるコンテンツのうち、大部分は静的コンテンツです。CDN を使用することで、パフォーマンスと全体的なユーザー エクスペリエンスを維持することができます。また、アプリケーションを複数のデータセンターにデプロイする必要がなくなります。
* IoT (モノのインターネット) ソリューションをサポートするアプリケーションでの負荷の増大に対処する。 関係するデバイスやアプライアンスが多数あり、アプリケーションでブロードキャスト メッセージを処理し、各デバイスへのファームウェア更新プログラムの配布を直接管理する必要がある場合、そのアプリケーションはすぐに処理できなくなります。
* アプリケーションを拡張することなく、ピーク時や需要の急騰に対処。結果として、運用コストの増加を防ぐことができます。 たとえば、特定モデルのルーターなどのハードウェア デバイス、またはスマート TV などのコンシューマー デバイスを対象にした、オペレーティング システムの更新プログラムがリリースされた場合、短期間で数百万単位のユーザーやデバイスがダウンロードするので、需要が大きく跳ね上がります。

次の表は、さまざまな場所の 1 バイト目の配信にかかる平均時間の例です。 ターゲット Web ロールは、Azure 米国西部にデプロイされています。 CDN を利用して時間が大きく短縮された場所と、CDN ノードとの近さには強い相関関係があります。 Azure CDN ノードの場所の完全な一覧は、[Azure Content Delivery Network (CDN) ノードの場所](/azure/cdn/cdn-pop-locations/)に関するページを参照してください。

|  | 1 バイト目にかかる時間 (ms) (配信元) | 1 バイト目にかかる時間 (ms) (CDN) | %CDN 時間の改善 |
| --- | --- | --- | --- |
| \*カリフォルニア州サンホセ |47.5 |46.5 |2% |
| \*\*バージニア州ダレス |109 |40.5 |169% |
| ブエノス アイレス (アルゼンチン) |210 |151 |39% |
| \*ロンドン (英国) |195 |44 |343% |
| 上海 (中国) |242 |206 |17% |
| \*シンガポール |214 |74 |189% |
| \*東京 (日本) |163 |48 |204% |
| ソウル (韓国) |190 |190 |0% |

\* 同じ都市に Azure CDN ノードがあります。  
\*\* 隣接する都市に Azure CDN ノードがあります。  

## <a name="challenges"></a>課題
CDN の使用を計画する際には、いくつかの課題を考慮する必要があります。  

* **デプロイ**」を参照してください。 CDN のコンテンツ取得元を決定する必要があります。また、複数のストレージ システム (CDN と代替の場所など) にあるコンテンツをデプロイする必要があるかどうかを決定する必要があります。

  アプリケーションのデプロイ メカニズムでは、静的なコンテンツとリソースのデプロイのプロセスだけでなく、ASPX ページなどのアプリケーション ファイルのデプロイのプロセスも考慮する必要があります。 たとえば、Azure BLOB ストレージにコンテンツを読み込むために個別の手順の実装が必要になる場合があります。
* **バージョン管理とキャッシュ制御**。 静的コンテンツを更新する方法と、新しいバージョンをデプロイする方法を検討する必要があります。 CDN コンテンツは新しい資産のバージョンが使用できるようになったら、Azure ポータルを使用して[消去](/azure/cdn/cdn-purge-endpoint/)できます。 これは、クライアント側のキャッシュを管理する場合の課題に類似しています (たとえば、Web ブラウザーで発生する課題)。
* **テスト**。 アプリケーションをローカル環境やステージング環境で開発し、テストしている場合、CDN の設定をローカルでテストすることは困難になる可能性があります。
* **検索エンジンの最適化 (SEO)**。 CDN を使用する場合、イメージやドキュメントなどのコンテンツは異なるドメインから提供されます。 このことは、このコンテンツの SEO に影響を及ぼします。
* **コンテンツのセキュリティ**。 Azure などの多くの CDN サービスは、現在のところ、どのような種類のコンテンツのアクセス制御も提供していません。
* **クライアントのセキュリティ**。 クライアントは、CDN 上のリソースへのアクセスを許可していない環境から接続している可能性があります。 たとえば、既知のリソースにのみアクセスが制限されているセキュリティに制約のある環境や、ページの提供元以外から配信されたリソースを読み込まない環境などです。 このような場合に対処するには、フォールバックの実装が必要です。
* **回復力**。 CDN は、アプリケーションの単一障害点になる可能性があります。 CDN の可用性に関する SLA は BLOB ストレージよりも低いので (BLOB ストレージはコンテンツの直接配信に使用できます)、必要に応じて、重要なコンテンツ用にフォールバック メカニズムの実装を検討します。

  [リアルタイム](/azure/cdn/cdn-real-time-stats/)の[集計レポート](/azure/cdn/cdn-analyze-usage-patterns/)で、CDN コンテンツの可用性、帯域幅、転送データ、ヒット数、キャッシュ ヒット率、キャッシュ メトリックを Azure ポータルから監視することができます。

CDN が適していないシナリオを次に示します。  

* コンテンツの有効期間中に、コンテンツのヒット率が低く、ほとんどアクセスされない場合 (その有効期限設定で決定)。 アイテムが初めてダウンロードされると、2 つのトランザクション料金が発生します (提供元から CDN、CDN からユーザー)。
* データが非公開の場合。たとえば、大規模な企業やサプライ チェーンのエコシステムなどです。

## <a name="general-guidelines-and-good-practices"></a>一般的なガイドラインと推奨される方法
CDN は、アプリケーションの負荷を最小限に抑え、可用性とパフォーマンスを最大限にするために有効な方法です。 アプリケーションで使用する適切なコンテンツとリソースのすべてに対して、この手法の採用を検討する必要があります。 CDN の使用戦略を立てるときは、次のセクションに示す項目を考慮してください。  

### <a name="origin"></a>Origin (配信元)
CDN 経由でコンテンツをデプロイするには、CDN サービスでコンテンツにアクセスおよびコンテンツをキャッシュするときに使用する HTTP エンドポイントまたは HTTPS エンドポイントを指定する必要があります。

エンドポイントでは、CDN 経由で配信する静的なコンテンツを保持する Azure BLOB ストレージ コンテナーを指定できます。 コンテナーは、パブリックと指定する必要があります。 CDN 経由で使用できるのは、パブリック読み取りアクセス権を持つパブリック コンテナー内の BLOB のみです。

エンドポイントは、アプリケーションのいずれかのコンピューティング層 (Web ロール、仮想マシンなど) のルートにある **cdn** というフォルダーを指定できます。 ASPX ページなどの動的リソースを含め、リソースに対する要求の結果は、CDN にキャッシュされます。 最短のキャッシュ期間は 300 秒です。 これより短い期間にすると、コンテンツを CDN にデプロイできなくなります (詳細については下記の見出し「*キャッシュ制御*」を参照してください)。

Azure Web Apps を使用している場合、エンドポイントは、CDN インスタンスを作成するときに選択したサイトのルート フォルダーに設定されます。 サイトのすべてのコンテンツは、CDN を介して使用できるようになります。

ほとんどの場合、アプリケーションのコンピューティング層のいずれかにあるフォルダーの CDN エンドポイントを指定すると、より柔軟に細かく制御できます。 たとえば、現在と将来のルーティング要件の管理、イメージのサムネイルなどの静的コンテンツの動的生成が簡単になります。

ASPX ページなどの動的ソースからコンテンツを配信する場合、キャッシュ内のオブジェクトを区別するために[クエリ文字列](/azure/cdn/cdn-query-string/)を使用することができます。 また、Azure ポータルで CDN エンドポイントを指定するときに、この動作を無効にすることもできます。 BLOB ストレージからコンテンツを配信する場合、クエリ文字列は文字列リテラルとして扱われるので、名前が同じでクエリ文字列が同じアイテムが 2 つある場合、CDN では別のアイテムとして保存されます。

スクリプトや他のコンテンツなどのリソースの URL 書き換えを利用すると、ファイルが CDN の配信元フォルダーに移動されることを回避できます。

Azure ストレージ BLOB を使用して CDN のコンテンツを保存する場合、BLOB 内にあるリソースの URL で、コンテナーと BLOB の名前の大文字と小文字は区別されます。

カスタム配信元または Azure Web Apps を使用している場合は、リソースへのリンクに CDN インスタンスのパスを指定します。 次の例では、CDN を介して配信されるサイトの **Images** フォルダー内のイメージ ファイルを指定しています。

```XML
<img src="http://[your-cdn-endpoint].azureedge.net/Images/image.jpg" />
```

### <a name="deployment"></a>デプロイ
アプリケーション デプロイメント パッケージまたはプロセスに静的コンテンツを含めない場合は、必要に応じて、アプリケーションとは別に静的コンテンツをプロビジョニングおよびデプロイします。 アプリケーション コンポーネントと静的リソース コンテンツの両方を管理するために使用するバージョン管理アプローチに対して、どのような影響があるかを考慮してください。

スクリプトと CSS ファイルのバンドル (複数のファイルを 1 つにまとめる処理) と縮小 (空白、改行文字、コメントなどの不要な文字の削除) を処理する方法について考慮します。 これらは、クライアントの読み込み時間を短縮することができ、CDN を介したコンテンツ配信と互換性がある一般的に使用される手法です。 詳細については、「 [バンドルと縮小](http://www.asp.net/mvc/tutorials/mvc-4/bundling-and-minification)」を参照してください。

コンテンツを追加の場所にデプロイする必要がある場合、デプロイメント プロセスの手順が増えます。 アプリケーションが、定期的に、またはイベントに応じて CDN のコンテンツを更新すると、更新されたコンテンツを CDN のエンドポイントだけでなく追加の場所にも保存する必要があります。

Visual Studio のローカルの Azure エミュレーターでアプリケーションの CDN エンドポイントを設定できません。 この制限は、単体テスト、機能テスト、最終的なデプロイメント前テストに影響があります。 代替メカニズムを実装して、この問題に対応する必要があります。 たとえば、カスタム アプリケーションまたはユーティリティを使用して CDN にコンテンツを事前デプロイして、キャッシュされている期間にテストを実行する方法があります。 また、コンパイル ディレクティブまたはグローバル定数を使用して、アプリケーションがリソースを読み込む場所を制御する方法もあります。 たとえば、デバッグ モードで実行するときは、クライアント側スクリプト バンドルや他のコンテンツなどのリソースをローカル フォルダーから読み込み、リリース モードで実行するときは CDN を使用することができます。

CDN でサポートする圧縮方法を検討します。

* 配信元サーバーで[圧縮を有効](/azure/cdn/cdn-improve-performance/)にします。この方法では、CDN は既定で圧縮をサポートし、圧縮されたコンテンツを zip または gzip の形式でクライアントに配信します。 CDN エンドポイントとしてアプリケーション フォルダーを使用する場合、サーバーは、Web ブラウザーまたは他の種類のクライアントに直接配信するときと同じ方法で、一部のコンテンツを自動的に圧縮することができます。 形式は、クライアントから送信された要求の **Accept-Encoding** ヘッダーの値に依存します。 Azure の既定のメカニズムでは、CPU 使用率が 50% を下回るとコンテンツが自動的に圧縮されます。 クラウド サービスを使用してアプリケーションをホストしている場合、この設定を変更するにはスタートアップ タスクを使用して IIS での動的出力の圧縮を有効にすることが必要な場合があります。 詳細については、[Web ロールを介した Microsoft Azure CDN による gzip 圧縮の有効化](http://blogs.msdn.com/b/avkashchauhan/archive/2012/03/05/enableing-gzip-compression-with-windows-azure-cdn-through-web-role.aspx)に関するページを参照してください。
* CDN エッジ サーバーで直接、圧縮を有効にします。この方法では、CDN でファイルが圧縮され、エンド ユーザーに渡されます。 詳細については、[Azure CDN の圧縮](/azure/cdn/cdn-improve-performance/)に関するページを参照してください。

### <a name="routing-and-versioning"></a>ルーティングとバージョン管理
さまざまな時点でそれぞれ異なる CDN インスタンスを使用することが必要な場合があります。 たとえば、アプリケーションの新しいバージョンをデプロイする場合は、新しい CDN を使用し、前の CDN は以前のバージョンのために保持することができます (以前の形式でコンテンツを保持)。 コンテンツ配信元として Azure BLOB ストレージを使用している場合は、別のストレージ アカウントまたは別のコンテナーを作成し、CDN エンドポイントでその場所を指定します。 CDN エンドポイントとしてアプリケーション内で CDN ルート フォルダーを使用している場合、要求を別のフォルダーに送信する URL の書き換え手法を使用できます。

Azure BLOB ストレージからコンテンツを取得するときに、クエリ文字列はリソース名 (BLOB 名) の一部になるので、CDN 上のリソースに対するリンクで、クエリ文字列を使用してアプリケーションの別バージョンを指定しないでください。 この方法はまた、クライアントでリソースをキャッシュする方法に影響する可能性があります。

以前のリソースが CDN にキャッシュされている場合、アプリケーションの更新時に新しいバージョンの静的コンテンツをデプロイすることが困難になる可能性があります。 詳細については、「*キャッシュ制御*」セクションを参照してください。

国によって CDN コンテンツへのアクセスを制限することを検討してください。 Azure CDN を使用すると、発信元の国に基づいて要求をフィルター処理し、配信するコンテンツを制限することができます。 詳細については、「[国に応じてコンテンツへのアクセスを制限する](/azure/cdn/cdn-restrict-access-by-country/)」をご覧ください。

### <a name="cache-control"></a>キャッシュ制御
システム内でのキャッシュの管理方法について検討します。 たとえば、CDN 配信元としてフォルダーを使用している場合、コンテンツを生成するページのキャッシュ可能性と、特定のフォルダーのすべてのリソースについてコンテンツ有効期限を指定できます。 CDN と、標準の HTTP ヘッダーを使用するクライアントのキャッシュ プロパティを指定することもできます。 サーバーとクライアントのキャッシュを既に管理している場合でも、CDN を使用すると、コンテンツのキャッシュ方法と場所を把握しやすくなります。

配信元 (BLOB コンテナーまたはアプリケーション *cdn* ルート フォルダー) から削除できるオブジェクトを CDN で使用できないようにするには、CDN エンドポイントを削除するか、(BLOB ストレージの場合は) コンテナーまたは BLOB を非公開にします。 ただし、アイテムが CDN から削除されるのは、有効期限が切れたときのみです。 キャッシュの有効期限が指定されていない場合 (コンテンツを BLOB ストレージから読み込まれたときなど)、CDN には最長 7 日間キャッシュされます。  また、手動で [CDN エンドポイントを消去する](/azure/cdn/cdn-purge-endpoint/)こともできます。

Web アプリケーションの場合、すべてのコンテンツにキャッシュと有効期限を設定するには、web.config ファイルの *system.webServer/staticContent* セクションで *clientCache* 要素を使用します。 web.config ファイルを任意のフォルダーに配置すると、そのフォルダーおよびすべてのサブフォルダー内のファイルが影響を受けます。

CDN のコンテンツを動的に作成する場合 (たとえば、アプリケーション コードで)、各ページに *Cache.SetExpires* プロパティを必ず指定します。 CDN では、 *パブリック*の既定のキャッシュ可能性設定を使用しているページからの出力をキャッシュしません。  コンテンツの破棄を防ぎ、ごく短い間隔でアプリケーションから読み込み直すようにキャッシュ有効期限を適切な値に設定します。  

### <a name="security"></a>セキュリティ
CDN は、CDN から提供された証明書を使用して HTTPS (SSL) 上でコンテンツを配信できますが、HTTP 上で配信することもできます。 コンテンツが混合している事に関するブラウザーからの警告を避けるには、HTTPS を使用して、HTTPS 経由で読み込まれたページに表示されている静的コンテンツを要求する必要があります。

CDN を使用してフロント ファイルなどの静的アセットを配信する場合は、 *XMLHttpRequest* 呼び出しを使用して異なるドメインからこれらのリソースを要求すると、同じ配信元ポリシーの問題が起こる場合があります。 多くの Web ブラウザーは、適切な応答ヘッダーを設定するように Web サーバーが構成されていない場合、クロス オリジン リソース共有 (CORS) を回避します。 次のいずれかの方法を使用して、CORS をサポートする CDN を構成できます。

* CORS ヘッダーを応答に追加するには、CDN ルール エンジンを使用します。 ワイルドカードと複数の個別の許可された配信元が使用できるため、通常はこれが最適な方法です。 詳細については、[CORS を使用する Azure CDN](https://docs.microsoft.com/en-us/azure/cdn/cdn-cors) に関するページを参照してください。 
* サービス プロパティに *CorsRule* を追加します。 また、コンテンツの配信元が Azure BLOB ストレージである場合、この方法を使用できます。 ルールには、CORS 要求に許可される配信元、GET などの許可されるメソッド、ルールの最長有効期間 (秒) (元のコンテンツを読み込んだ後に、リンクされているリソースをクライアントが要求する必要がある期間) を指定できます。 CDN で使用するストレージに CORS を設定した場合、許可配信元一覧にはワイルドカード ‘*’ のみ使用できます。 詳細については、「 [Azure ストレージ サービスでのクロス オリジン リソース共有 (CORS) のサポート](http://msdn.microsoft.com/library/azure/dn535601.aspx)」を参照してください。
* アプリケーション構成ファイルの送信ルールで、すべての応答に *Access-Control-Allow-Origin* ヘッダーを設定します。 配信元サーバーで IIS を実行している場合は、この方法を使用できます。 CDN でこの方法を使用する場合、許可配信元一覧にはワイルドカード ‘*’ のみ使用できます。 書き換えルールの詳細については、「 [URL 書き換えモジュール](http://www.iis.net/learn/extensions/url-rewrite-module)」を参照してください。

### <a name="custom-domains"></a>カスタム ドメイン
Azure CDN など、ほとんどの CDN では、[カスタム ドメイン名](/azure/cdn/cdn-map-content-to-custom-domain/)を指定し、それを使用して CDN 経由でリソースにアクセスすることができます。 また、DNS の *CNAME* レコードを使用してカスタム サブドメインを設定することもできます。 このアプローチを使用すると、抽象化と制御の層を追加することができます。

*CNAME* を使用している場合、SSL を使用することはできません。これは、CDN は独自の単一 SSL 証明書を使用しており、この証明書はカスタム ドメイン名/サブドメイン名と一致しないためです。

### <a name="cdn-fallback"></a>CDN フォールバック
CDN のエラーや一時的な使用不能状態に対するアプリケーションの対応方法を考慮する必要があります。 クライアント アプリケーションは、前回の要求中に (クライアントの) ローカルにキャッシュされたリソースのコピーを使用できる場合があります。CDN を使用できない場合は、エラーを検出すると、そこで配信元 (リソースが保存されているアプリケーション フォルダーまたは Azure BLOB コンテナー) にリソースを要求するコードを含めることもできます。

次の例は、Razor ビュー の [Tag Helpers](https://docs.microsoft.com/en-us/aspnet/core/mvc/views/tag-helpers/intro) を使用するフォールバック メカニズムを示しています。

```HTML
...
<link rel="stylesheet" href="https://[your-cdn-endpoint].azureedge.net/lib/bootstrap/dist/css/bootstrap.min.css"
      asp-fallback-href="~/lib/bootstrap/dist/css/bootstrap.min.css"
      asp-fallback-test-class="sr-only" asp-fallback-test-property="position" asp-fallback-test-value="absolute"/>
<link rel="stylesheet" href="~/css/site.min.css" asp-append-version="true"/>
...
<script src="https://[your-cdn-endpoint].azureedge.net/lib/jquery/dist/jquery-2.2.0.min.js"
        asp-fallback-src="~/lib/jquery/dist/jquery.min.js"
        asp-fallback-test="window.jQuery">
</script>
<script src="https://[your-cdn-endpoint].azureedge.net/lib/bootstrap/dist/js/bootstrap.min.js"
        asp-fallback-src="~/lib/bootstrap/dist/js/bootstrap.min.js"
        asp-fallback-test="window.jQuery && window.jQuery.fn && window.jQuery.fn.modal">
</script>
...
```

### <a name="search-engine-optimization"></a>検索エンジンの最適化
ご使用のアプリケーションで SEO が重要な考慮事項がある場合は、次のタスクを実行します。

* 各ページまたはリソースに標準の *Rel* ヘッダーを含めます。
* *CNAME* サブドメイン レコードを使用し、その名前を使用してリソースにアクセスします。
* CDN の IP アドレスは、アプリケーションの国または地域とは異なる可能性があります。その影響を考慮してください。
* Azure BLOB ストレージを配信元として使用する場合、CDN のリソースについて、アプリケーション フォルダーと同じファイル構造を維持します。

### <a name="monitoring-and-logging"></a>監視およびログ記録
アプリケーションの監視戦略の一部として CDN を含めて、エラーまたは長い待機時間の発生を検出して測定します。  Azure ポータル サイトにある CDN プロファイル マネージャーで監視機能を利用することができます。

CDN のログ記録を有効にして、日常業務の一環としてこのログを監視します。

CDN トラフィックを分析して使用パターンを確認することを検討してください。 Azure ポータルには、次を監視できるツールが用意されています。

* 帯域幅、
* 転送されたデータ、
* ヒット数 (状態コード)、
* キャッシュの状態、
* キャッシュ ヒット率、
* IPv4/IPv6 要求率。

詳細については、[CDN の使用パターンの分析](/azure/cdn/cdn-analyze-usage-patterns/)に関するページを参照してください。

### <a name="cost-implications"></a>コストの見込み
CDN からの送信データ転送に対して課金されます。  さらに、BLOB ストレージを使用して、資産をホストしている場合、CDN がアプリケーションからデータを読み込むときに、ストレージ トランザクションに対して課金されます。 コンテンツに適した現実的なキャッシュ有効期間は、コンテンツの鮮度を確保し、アプリケーションまたは BLOB ストレージから CDN にコンテンツが繰り返し読み込まれない程度の短かすぎない時間に設定する必要があります。

あまりダウンロードされないアイテムでも 2 つのトランザクション料金が発生し、サーバーの負荷が大きく減ることはありません。

### <a name="bundling-and-minification"></a>バンドルと縮小
バンドルや縮小を使用して、CDN に格納された JavaScript コードや HTML ページなどのリソースのサイズを削減します。 この方法は、これらのアイテムをクライアントにダウンロードするのにかかる時間の短縮に役立ちます。

バンドルと縮小は、ASP.NET で処理することができます。 MVC プロジェクトでは、*BundleConfig.cs* でバンドルを定義します。 縮小されたスクリプト バンドルの参照は通常、コードのビュー クラスで *Script.Render* を呼び出して作成します。 この参照には、ハッシュを含むクエリ文字列が含まれます。ハッシュは、バンドルのコンテンツに基づいています。 バンドルの内容が変わると、生成されるハッシュも変わります。  

既定の Azure CDN のインスタンスでは、 *クエリ文字列のステータス* 設定が無効にされています。 更新されたスクリプトのバンドルを CDN で適切に処理できるように、CDN インスタンスの *クエリ文字列ステータス* を有効にする必要があります。 設定が有効になるまで 1 時間以上かかる場合があります。

### <a name="features"></a>Features (機能)

Azure には、いくつかの CDN 製品があります。 CDN を選択する場合は、各製品でサポートされる機能を考慮してください。 詳細については、[Azure CDN 機能][cdn-features]を参照してください。 含めることを検討すべき Premium 機能は次のとおりです。

- **[ルール エンジン](/azure/cdn/cdn-rules-engine)**。 規則エンジンでは、特定の種類のコンテンツの配信のブロック、キャッシュ ポリシーの定義、HTTP ヘッダーの変更など、HTTP 要求の処理方法をカスタマイズできます。 

- **[リアルタイム統計情報](/azure/cdn/cdn-real-time-stats)**。 帯域幅、キャッシュの状態、CDN プロファイルへの同時接続数などに関するリアルタイムのデータを監視し、[リアルタイム アラートを受信](/azure/cdn/cdn-real-time-alerts)できます。 


## <a name="rules-engine-url-rewriting-example"></a>ルール エンジン URL 書き換えの例

次の図は、CDN を使用している場合の [URL 書き換え](https://technet.microsoft.com/library/ee215194.aspx)方法を示しています。 キャッシュされているコンテンツに対する CDN からの要求は、リソースの種類 (スクリプトやイメージなど) に基づいて、アプリケーション ルート内の特定のフォルダーにリダイレクトされます。  

![ルール エンジン図](./images/cdn/rules-engine.png)

このような書き換えルールでは、次のリダイレクトが実行されます。

* 最初のルールでは、リソースのファイル名にバージョンを埋め込むことができますが、これは無視されます。 たとえば、ファイル名 *Filename_v123.jpg* は *Filename.jpg* と書き換えられます。
* 次の 4 つの規則は、Web ロールのルートにある *cdn** というフォルダーにリソースを保存しない場合に、要求をリダイレクトする方法を示しています。 これらの規則では、*cdn/Images*、*cdn/Content*、*cdn/Scripts* および *cdn/bundles* の 4 つの URL が、Web ロールの各ルート フォルダーにマッピングされます。

URL の書き換えを使用するには、リソースのバンドルにいくつかの変更を加える必要があります。     

## <a name="more-information"></a>詳細情報
* [Azure CDN](https://azure.microsoft.com/services/cdn/)
* [Azure Content Delievery Network (CDN) のドキュメント](https://azure.microsoft.com/documentation/services/cdn/)
* [Azure CDN の使用](/azure/cdn/cdn-create-new-endpoint/)
* [Azure CDN でクラウド サービスを統合 ](/azure/cdn/cdn-cloud-service-with-cdn/)(https://azure.microsoft.com/blog/2011/03/18/best-practices-for-the-windows-azure-content-delivery-network/)


<!-- links -->

[cdn-features]: /azure/cdn/cdn-overview#azure-cdn-features
